System.register(["./fog-c82f3158.js","./screen-b918b2af.js"],(function(t){"use strict";var e,s,i,n,a,h,r,o,l,_,d,u,c,f,g,m,p,A,S,I,E,y,L,b,v,N,M,B,R,T,C,D,P,H,F,O,U,w,k,G,V,W,z,x,Y,Z,K,X,Q,j,q,J,$,tt,et,st,it,nt,at,ht,rt,ot,lt,_t,dt,ut,ct,ft,gt,mt,pt,At,St,It,Et,yt,Lt,bt,vt;return{setters:[function(t){e=t.b_,s=t.bT,i=t.ch,n=t.c1,a=t.c3,h=t.t,r=t.cg,o=t.g0,l=t.eM,_=t.gy,d=t.gz,u=t.dF,c=t.dE,f=t.ei,g=t.l,m=t.bJ,p=t.cW,A=t.eN,S=t.cD,I=t.cC,E=t.bs,y=t.c9,L=t.bI,b=t.bV,v=t.bW,N=t.c8,M=t.gA,B=t.aS,R=t.f,T=t.bQ,C=t.bS,D=t.aG,P=t.d1,H=t.P,F=t.bO,O=t.L,U=t.N,w=t.cb,k=t.bZ,G=t.b$,V=t.ca,W=t.c4,z=t.bR,x=t.cf,Y=t.ce,Z=t.gB,K=t.ev,X=t.cY,Q=t.em,j=t.bP,q=t.gc,J=t.bU,$=t.F,tt=t.b0,et=t.b9,st=t.gC,it=t.ap,nt=t.z,at=t.G,ht=t.c_,rt=t.cr,ot=t.f_,lt=t.ey,_t=t.eQ,dt=t.eY,ut=t.e1,ct=t.fz,ft=t.fV,gt=t.gD,mt=t.fA,pt=t.f3,At=t.ek,St=t.fB},function(t){It=t.e,Et=t.L,yt=t.g,Lt=t.I,bt=t.n,vt=t.M}],execute:function(){t("M",void 0);var Nt=t("R",function(){function t(t){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._scenePoolHandle=s,this._modelArrayHandle=s,this._batchArrayHandle=s,this._sphereLightsHandle=s,this._spotLightsHandle=s,this._root=t,this._createHandles()}t.registerCreateFunc=function(e){e._createSceneFun=function(e){return new t(e)}};var _=t.prototype;return _.initialize=function(t){return this._name=t.name,this._createHandles(),!0},_.update=function(t){var e=this._mainLight;e&&e.update();for(var s=this._sphereLights,i=0;i<s.length;i++)s[i].update();for(var n=this._spotLights,a=0;a<n.length;a++)n[a].update();for(var h=this._models,r=0;r<h.length;r++){var o=h[r];o.enabled&&(o.updateTransform(t),o.updateUBOs(t))}},_.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._modelArrayHandle&&(e.free(this._modelArrayHandle),this._modelArrayHandle=s),this._scenePoolHandle&&(i.free(this._scenePoolHandle),this._scenePoolHandle=s),this._sphereLightsHandle&&(n.free(this._sphereLightsHandle),this._sphereLightsHandle=s),this._spotLightsHandle&&(n.free(this._spotLightsHandle),this._spotLightsHandle=s),this._batchArrayHandle&&(a.free(this._batchArrayHandle),this._batchArrayHandle=s)},_.addCamera=function(t){t.attachToScene(this),this._cameras.push(t)},_.removeCamera=function(t){for(var e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return this._cameras.splice(e,1),void t.detachFromScene()},_.removeCameras=function(){for(var t,e=h(this._cameras);!(t=e()).done;)t.value.detachFromScene();this._cameras.splice(0)},_.setMainLight=function(t){this._mainLight=t,i.set(this._scenePoolHandle,r.MAIN_LIGHT,t.handle)},_.unsetMainLight=function(t){if(this._mainLight===t){var e=this._directionalLights;e.length?(this._mainLight=e[e.length-1],this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=o.ROTATION)):this._mainLight=null}},_.addDirectionalLight=function(t){t.attachToScene(this),this._directionalLights.push(t)},_.removeDirectionalLight=function(t){for(var e=0;e<this._directionalLights.length;++e)if(this._directionalLights[e]===t)return t.detachFromScene(),void this._directionalLights.splice(e,1)},_.addSphereLight=function(t){t.attachToScene(this),this._sphereLights.push(t),n.push(this._sphereLightsHandle,t.handle)},_.removeSphereLight=function(t){for(var e=0;e<this._sphereLights.length;++e)if(this._sphereLights[e]===t)return t.detachFromScene(),this._sphereLights.splice(e,1),void n.erase(this._sphereLightsHandle,e)},_.addSpotLight=function(t){t.attachToScene(this),this._spotLights.push(t),n.push(this._spotLightsHandle,t.handle)},_.removeSpotLight=function(t){for(var e=0;e<this._spotLights.length;++e)if(this._spotLights[e]===t)return t.detachFromScene(),this._spotLights.splice(e,1),void n.erase(this._spotLightsHandle,e)},_.removeSphereLights=function(){for(var t=0;t<this._sphereLights.length;++t)this._sphereLights[t].detachFromScene();this._sphereLights.length=0,n.clear(this._sphereLightsHandle)},_.removeSpotLights=function(){for(var t=0;t<this._spotLights.length;++t)this._spotLights[t].detachFromScene();this._spotLights=[],n.clear(this._spotLightsHandle)},_.addModel=function(t){t.attachToScene(this),this._models.push(t),e.push(this._modelArrayHandle,t.handle)},_.removeModel=function(t){for(var s=0;s<this._models.length;++s)if(this._models[s]===t)return t.detachFromScene(),this._models.splice(s,1),void e.erase(this._modelArrayHandle,s)},_.removeModels=function(){for(var t,s=h(this._models);!(t=s()).done;){var i=t.value;i.detachFromScene(),i.destroy()}this._models.length=0,e.clear(this._modelArrayHandle)},_.addBatch=function(t){this._batches.push(t),a.push(this._batchArrayHandle,t.handle)},_.removeBatch=function(t){for(var e=0;e<this._batches.length;++e)if(this._batches[e]===t)return this._batches.splice(e,1),void a.erase(this._batchArrayHandle,e)},_.removeBatches=function(){this._batches.length=0,a.clear(this._batchArrayHandle)},_.onGlobalPipelineStateChanged=function(){for(var t,e=h(this._models);!(t=e()).done;)t.value.onGlobalPipelineStateChanged()},_.generateModelId=function(){return this._modelId++},_._createHandles=function(){this._modelArrayHandle||(this._modelArrayHandle=e.alloc(),this._scenePoolHandle=i.alloc(),i.set(this._scenePoolHandle,r.MODEL_ARRAY,this._modelArrayHandle),this._spotLightsHandle=n.alloc(),i.set(this._scenePoolHandle,r.SPOT_LIGHT_ARRAY,this._spotLightsHandle),this._sphereLightsHandle=n.alloc(),i.set(this._scenePoolHandle,r.SPHERE_LIGHT_ARRAY,this._sphereLightsHandle)),this._batchArrayHandle||(this._batchArrayHandle=a.alloc(),i.set(this._scenePoolHandle,r.BATCH_ARRAY_2D,this._batchArrayHandle))},l(t,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"handle",get:function(){return this._scenePoolHandle}},{key:"batches",get:function(){return this._batches}}]),t}());t("r",_("requireComponent")),t("e",_("executionOrder")),t("f",d),u(Nt.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),u(Nt.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var Mt=t("C",{});u(Mt,"CameraVisFlags",[{name:"GENERAL"}]),c(Mt,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:f.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:f.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:f.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:f.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:f.BitMask,targetName:"UI_2D"}]),g.CameraVisFlags=Mt;var Bt=t("V",{});u(Bt,"VisibilityFlags",[{name:"GENERAL"}]),c(Bt,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:f.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:f.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:f.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:f.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:f.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:f.Enum,targetName:"UI_2D"}]),g.VisibilityFlags=Bt,c(m.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),u(It.prototype,"Camera.prototype",[{name:"getSplitFrustum"}]);var Rt,Tt=new p(0,0,-1),Ct=new p,Dt=(t("D",function(t){function e(){var e;return(e=t.call(this)||this)._dir=new p(1,-1,-1),e}A(e,t);var s=e.prototype;return s.initialize=function(){t.prototype.initialize.call(this),S.set(this._handle,I.ILLUMINANCE,E.SUN_ILLUM),S.setVec3(this._handle,I.DIRECTION,this._dir),S.set(this._handle,I.TYPE,Et.DIRECTIONAL)},s.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=p.transformQuat(Ct,Tt,this._node.worldRotation))},l(e,[{key:"direction",get:function(){return this._dir},set:function(t){p.normalize(this._dir,t),S.setVec3(this._handle,I.DIRECTION,this._dir)}},{key:"illuminance",get:function(){return S.get(this._handle,I.ILLUMINANCE)},set:function(t){S.set(this._handle,I.ILLUMINANCE,t)}}]),e}(yt)),new B(null)),Pt=t("c",function(){function t(){this._device=null,this._passes=null,this._subMesh=null,this._patches=null,this._handle=s,this._priority=M.DEFAULT,this._inputAssembler=null,this._descriptorSet=null}var e=t.prototype;return e.initialize=function(t,e,s){void 0===s&&(s=null),this._device=g.director.root.device,this._subMesh=t,this._patches=s,this._passes=e,this._handle=y.alloc(),this._flushPassInfo(),e[0].batchingScheme===L.VB_MERGING&&this._subMesh.genFlatBuffers(),Dt.layout=e[0].localSetLayout;var i=b.alloc(this._device,Dt),n=v.alloc(this._device,t.iaInfo);y.set(this._handle,N.PRIORITY,M.DEFAULT),y.set(this._handle,N.INPUT_ASSEMBLER,n),y.set(this._handle,N.DESCRIPTOR_SET,i),y.set(this._handle,N.SUB_MESH,t.handle),this._inputAssembler=v.get(n),this._descriptorSet=b.get(i)},e.initPlanarShadowShader=function(){var t=g.director.root.pipeline.pipelineSceneData.shadows.getPlanarShader(this._patches);y.set(this._handle,N.PLANAR_SHADER,t)},e.initPlanarShadowInstanceShader=function(){var t=g.director.root.pipeline.pipelineSceneData.shadows.getPlanarInstanceShader(this._patches);y.set(this._handle,N.PLANAR_INSTANCE_SHADER,t)},e.destroy=function(){b.free(y.get(this._handle,N.DESCRIPTOR_SET)),v.free(y.get(this._handle,N.INPUT_ASSEMBLER)),y.free(this._handle),this._descriptorSet=null,this._inputAssembler=null,this._priority=M.DEFAULT,this._handle=s,this._patches=null,this._subMesh=null,this._passes=null},e.update=function(){for(var t=0;t<this._passes.length;++t)this._passes[t].update();this._descriptorSet.update()},e.onPipelineStateChanged=function(){var t=this._passes;if(t){for(var e=0;e<t.length;e++){var s=t[e];s.beginChangeStatesSilently(),s.tryCompile(),s.endChangeStatesSilently()}this._flushPassInfo()}},e.onMacroPatchesStateChanged=function(t){this._patches=t;var e=this._passes;if(e){for(var s=0;s<e.length;s++){var i=e[s];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},e._flushPassInfo=function(){var t=this._passes;if(t){y.set(this._handle,N.PASS_COUNT,t.length);for(var e=N.PASS_0,s=N.SHADER_0,i=0;i<t.length;i++,e++,s++)y.set(this._handle,e,t[i].handle),y.set(this._handle,s,t[i].getShaderVariant(this._patches))}},l(t,[{key:"passes",get:function(){return this._passes},set:function(t){if(t.length>8)R(12004,8);else if(this._passes=t,this._flushPassInfo(),this._descriptorSet){b.free(y.get(this._handle,N.DESCRIPTOR_SET)),Dt.layout=t[0].localSetLayout;var e=b.alloc(this._device,Dt);y.set(this._handle,N.DESCRIPTOR_SET,e),this._descriptorSet=b.get(e)}}},{key:"subMesh",get:function(){return this._subMesh},set:function(t){this._subMesh=t,this._inputAssembler.destroy(),this._inputAssembler.initialize(t.iaInfo),this._passes[0].batchingScheme===L.VB_MERGING&&this._subMesh.genFlatBuffers(),y.set(this._handle,N.SUB_MESH,t.handle)}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t,y.set(this._handle,N.PRIORITY,t)}},{key:"handle",get:function(){return this._handle}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarShaderHandle",get:function(){return y.get(this._handle,N.PLANAR_SHADER)}},{key:"planarInstanceShaderHandle",get:function(){return y.get(this._handle,N.PLANAR_INSTANCE_SHADER)}}]),t}()),Ht=new T(C.ATTRIBUTE,(function(t,e){return e||new D})),Ft=new P,Ot=new H((function(){return new Pt}),32),Ut=[{name:"CC_RECEIVE_SHADOW",value:!0}];!function(t){t[t.DEFAULT=0]="DEFAULT",t[t.SKINNING=1]="SKINNING",t[t.BAKED_SKINNING=2]="BAKED_SKINNING",t[t.BATCH_2D=3]="BATCH_2D",t[t.PARTICLE_BATCH=4]="PARTICLE_BATCH",t[t.LINE=5]="LINE"}(Rt||(Rt=t("M",{})));var wt,kt,Gt,Vt,Wt,zt,xt,Yt,Zt,Kt,Xt=F([O.LINEAR,O.LINEAR,O.NONE,U.CLAMP,U.CLAMP,U.CLAMP]),Qt=F([O.LINEAR,O.LINEAR,O.LINEAR,U.CLAMP,U.CLAMP,U.CLAMP]),jt=(t("a",function(){function t(){this.type=Rt.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._transformUpdated=!0,this._handle=s,this._hWorldBounds=s,this._localData=new Float32Array(Z.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new X,this._device=g.director.root.device}var e=t.prototype;return e.initialize=function(){if(!this._inited){this._handle=w.alloc();var t=k.alloc(),e=G.alloc();w.set(this._handle,V.INSTANCED_ATTR_ARRAY,e),w.set(this._handle,V.SUB_MODEL_ARRAY,t),w.set(this._handle,V.VIS_FLAGS,f.Enum.NONE),w.set(this._handle,V.ENABLED,1),w.set(this._handle,V.RECEIVE_SHADOW,1),w.set(this._handle,V.CAST_SHADOW,0),this._inited=!0}},e.destroy=function(){for(var t=this._subModels,e=0;e<t.length;e++){var i=this._subModels[e];i.destroy(),Ot.free(i)}if(this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._transformUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._handle){var n=w.get(this._handle,V.SUB_MODEL_ARRAY);n&&k.free(n);var a=w.get(this._handle,V.INSTANCED_BUFFER);a&&W.free(a);var h=w.get(this._handle,V.INSTANCED_ATTR_ARRAY);h&&z(h,G,Ht),w.free(this._handle),this._handle=s}this._hWorldBounds&&(x.free(this._hWorldBounds),this._hWorldBounds=s)},e.attachToScene=function(t){this.scene=t},e.detachFromScene=function(){this.scene=null},e.updateTransform=function(){var t=this.transform;if(t.hasChangedFlags||t._dirtyFlags){t.updateWorldTransform(),this._transformUpdated=!0;var e=this._worldBounds;this._modelBounds&&e&&(this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e),x.setVec3(this._hWorldBounds,Y.CENTER,e.center),x.setVec3(this._hWorldBounds,Y.HALF_EXTENSION,e.halfExtents))}},e.updateWorldBound=function(){var t=this.transform;if(null!==t){t.updateWorldTransform(),this._transformUpdated=!0;var e=this._worldBounds;this._modelBounds&&e&&(this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e),x.setVec3(this._hWorldBounds,Y.CENTER,e.center),x.setVec3(this._hWorldBounds,Y.HALF_EXTENSION,e.halfExtents))}},e.updateUBOs=function(t){for(var e=this._subModels,s=0;s<e.length;s++)e[s].update();if(this._updateStamp=t,this._transformUpdated){this._transformUpdated=!1;var i,n,a,h,r=this.transform._mat,o=this._instMatWorldIdx;if(o>=0){var l=this.instancedAttributes.views;i=r,n=l[o],a=l[o+1],h=l[o+2],n[0]=i.m00,n[1]=i.m01,n[2]=i.m02,n[3]=i.m12,a[0]=i.m04,a[1]=i.m05,a[2]=i.m06,a[3]=i.m13,h[0]=i.m08,h[1]=i.m09,h[2]=i.m10,h[3]=i.m14}else this._localBuffer&&(P.toArray(this._localData,r,Z.MAT_WORLD_OFFSET),P.inverseTranspose(Ft,r),P.toArray(this._localData,Ft,Z.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData))}},e.createBoundingShape=function(t,e){t&&e&&(this._modelBounds=K.fromPoints(K.create(),t,e),this._worldBounds=K.clone(this._modelBounds),this._hWorldBounds===s&&(this._hWorldBounds=x.alloc(),w.set(this._handle,V.WORLD_BOUNDS,this._hWorldBounds)),x.setVec3(this._hWorldBounds,Y.CENTER,this._worldBounds.center),x.setVec3(this._hWorldBounds,Y.HALF_EXTENSION,this._worldBounds.halfExtents))},e.initSubModel=function(t,e,s){this.initialize();var i=!1;if(null==this._subModels[t]?(this._subModels[t]=Ot.alloc(),i=!0):this._subModels[t].destroy(),this._subModels[t].initialize(e,s.passes,this.getMacroPatches(t)),this._subModels[t].initPlanarShadowShader(),this._subModels[t].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(t),i){var n=w.get(this._handle,V.SUB_MODEL_ARRAY);k.assign(n,t,this._subModels[t].handle)}},e.setSubModelMesh=function(t,e){this._subModels[t]&&(this._subModels[t].subMesh=e)},e.setSubModelMaterial=function(t,e){this._subModels[t]&&(this._subModels[t].passes=e.passes,this._updateAttributesAndBinding(t))},e.onGlobalPipelineStateChanged=function(){for(var t=this._subModels,e=0;e<t.length;e++)t[e].onPipelineStateChanged()},e.onMacroPatchesStateChanged=function(){for(var t=this._subModels,e=0;e<t.length;e++)t[e].onMacroPatchesStateChanged(this.getMacroPatches(e))},e.updateLightingmap=function(t,e){X.toArray(this._localData,e,Z.LIGHTINGMAP_UVPARAM),this._lightmap=t,this._lightmapUVParam=e,null===t&&(t=Q.get("empty-texture"));var s=t.getGFXTexture();if(s)for(var i=j.getSampler(this._device,t.mipmaps.length>1?Qt:Xt),n=this._subModels,a=0;a<n.length;a++){var h=n[a].descriptorSet;h.bindTexture(q,s),h.bindSampler(q,i),h.update()}},e.getMacroPatches=function(){return this.receiveShadow?Ut:null},e._updateAttributesAndBinding=function(t){var e=this._subModels[t];if(e){this._initLocalDescriptors(t),this._updateLocalDescriptors(t,e.descriptorSet);var s=J.get(y.get(e.handle,N.SHADER_0));this._updateInstancedAttributes(s.attributes,e.passes[0])}},e._getInstancedAttributeIndex=function(t){for(var e=this.instancedAttributes.attributes,s=0;s<e.length;s++)if(e[s].name===t)return s;return-1},e._updateInstancedAttributes=function(t,e){if(e.device.hasFeature($.INSTANCED_ARRAYS)){var s=w.get(this._handle,V.INSTANCED_BUFFER);s&&W.free(s);var i=w.get(this._handle,V.INSTANCED_ATTR_ARRAY);i&&z(i,G,Ht,!1);for(var n=0,a=0;a<t.length;a++){var h=t[a];h.isInstanced&&(n+=tt[h.format].size)}var r=W.alloc(n),o=W.getBuffer(r);w.set(this._handle,V.INSTANCED_BUFFER,r);var l=this.instancedAttributes;l.buffer=new Uint8Array(o),l.views.length=l.attributes.length=0;for(var _=0,d=0;d<t.length;d++){var u=t[d];if(u.isInstanced){var c=Ht.alloc(),f=Ht.get(c);f.format=u.format,f.name=u.name,f.isNormalized=u.isNormalized,f.location=u.location,l.attributes.push(f),G.push(i,c);var g=tt[u.format];l.views.push(new(et(g))(o,_,g.count)),_+=g.size}}e.batchingScheme===L.INSTANCING&&Lt.get(e).destroy(),this._instMatWorldIdx=this._getInstancedAttributeIndex(st),this._transformUpdated=!0}},e._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new it(nt.UNIFORM|nt.TRANSFER_DST,at.HOST|at.DEVICE,Z.SIZE,Z.SIZE)))},e._updateLocalDescriptors=function(t,e){this._localBuffer&&e.bindBuffer(Z.BINDING,this._localBuffer)},l(t,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"receiveShadow",get:function(){return!!w.get(this._handle,V.RECEIVE_SHADOW)},set:function(t){w.set(this._handle,V.RECEIVE_SHADOW,t?1:0),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return!!w.get(this._handle,V.CAST_SHADOW)},set:function(t){w.set(this._handle,V.CAST_SHADOW,t?1:0)}},{key:"handle",get:function(){return this._handle}},{key:"node",get:function(){return this._node},set:function(t){this._node=t,w.set(this._handle,V.NODE,t.handle)}},{key:"transform",get:function(){return this._transform},set:function(t){this._transform=t,w.set(this._handle,V.TRANSFORM,t.handle)}},{key:"visFlags",get:function(){return w.get(this._handle,V.VIS_FLAGS)},set:function(t){w.set(this._handle,V.VIS_FLAGS,t)}},{key:"enabled",get:function(){return!!w.get(this._handle,V.ENABLED)},set:function(t){w.set(this._handle,V.ENABLED,t?1:0)}}]),t}()),t("S",function(t){function e(){var e;return(e=t.call(this)||this)._needUpdate=!1,e._pos=void 0,e._aabb=void 0,e._hAABB=s,e._aabb=K.create(),e._pos=new p,e}A(e,t);var i=e.prototype;return i.initialize=function(){t.prototype.initialize.call(this),this._hAABB=x.alloc(),S.set(this._handle,I.TYPE,Et.SPHERE),S.set(this._handle,I.SIZE,.15),S.set(this._handle,I.RANGE,1),S.set(this._handle,I.AABB,this._hAABB),S.set(this._handle,I.ILLUMINANCE,1700/bt(.15))},i.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var t=S.get(this._handle,I.RANGE);K.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,t,t,t),this._needUpdate=!1,S.setVec3(this._handle,I.POSITION,this._pos),x.setVec3(this._hAABB,Y.CENTER,this._aabb.center),x.setVec3(this._hAABB,Y.HALF_EXTENSION,this._aabb.halfExtents)}},i.destroy=function(){return this._hAABB&&(x.free(this._hAABB),this._hAABB=s),t.prototype.destroy.call(this)},l(e,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return S.get(this._handle,I.SIZE)},set:function(t){S.set(this._handle,I.SIZE,t)}},{key:"range",get:function(){return S.get(this._handle,I.RANGE)},set:function(t){S.set(this._handle,I.RANGE,t),this._needUpdate=!0}},{key:"luminance",get:function(){return S.get(this._handle,I.ILLUMINANCE)},set:function(t){S.set(this._handle,I.ILLUMINANCE,t)}},{key:"aabb",get:function(){return this._aabb}}]),e}(yt)),new p(0,0,-1)),qt=new ht,Jt=new P,$t=new P,te=new P,ee=new P,se=(t("b",function(t){function e(){var e;return(e=t.call(this)||this)._dir=new p(1,-1,-1),e._range=5,e._spotAngle=Math.cos(Math.PI/6),e._pos=void 0,e._aabb=void 0,e._frustum=void 0,e._angle=0,e._needUpdate=!1,e._hAABB=s,e._hFrustum=s,e._aabb=K.create(),e._frustum=lt.create(),e._pos=new p,e}A(e,t);var i=e.prototype;return i.initialize=function(){t.prototype.initialize.call(this),this._hAABB=x.alloc(),this._hFrustum=rt.alloc(),S.set(this._handle,I.TYPE,Et.SPOT),S.set(this._handle,I.SIZE,.15),S.set(this._handle,I.AABB,this._hAABB),S.set(this._handle,I.ILLUMINANCE,1700/bt(.15)),S.set(this._handle,I.RANGE,Math.cos(Math.PI/6)),S.set(this._handle,I.ASPECT,1),S.setVec3(this._handle,I.DIRECTION,this._dir),S.set(this._handle,I.FRUSTUM,this._hFrustum)},i.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),p.transformQuat(this._dir,jt,this._node.getWorldRotation(qt)),p.normalize(this._dir,this._dir),S.setVec3(this._handle,I.DIRECTION,this._dir),K.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(Jt),P.invert(Jt,Jt),P.perspective($t,this._angle,1,.001,this._range),P.multiply(te,$t,Jt),this._frustum.update(te,ee),this._needUpdate=!1,S.setVec3(this._handle,I.POSITION,this._pos),x.setVec3(this._hAABB,Y.CENTER,this._aabb.center),x.setVec3(this._hAABB,Y.HALF_EXTENSION,this._aabb.halfExtents),ot(this._hFrustum,this._frustum))},i.destroy=function(){return this._hAABB&&(x.free(this._hAABB),this._hAABB=s),this._hFrustum&&(rt.free(this._hFrustum),this._hFrustum=s),t.prototype.destroy.call(this)},l(e,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return S.get(this._handle,I.SIZE)},set:function(t){S.set(this._handle,I.SIZE,t)}},{key:"range",get:function(){return S.get(this._handle,I.RANGE)},set:function(t){this._range=t,S.set(this._handle,I.RANGE,t),this._needUpdate=!0}},{key:"luminance",get:function(){return S.get(this._handle,I.ILLUMINANCE)},set:function(t){S.set(this._handle,I.ILLUMINANCE,t)}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return S.get(this._handle,I.SPOT_ANGLE)},set:function(t){this._angle=t,S.set(this._handle,I.SPOT_ANGLE,Math.cos(.5*t)),this._needUpdate=!0}},{key:"aspect",get:function(){return S.get(this._handle,I.ASPECT)},set:function(t){S.set(this._handle,I.ASPECT,t),this._needUpdate=!0}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),e}(yt)),{parent:null,owner:null,subModelIdx:0}),ie=t("d",(wt=_t("cc.RenderableComponent"),kt=dt([ut]),Gt=dt(ut),Vt=ft(),Wt=gt(),wt((Kt=function(t){function e(){for(var e,s=arguments.length,i=new Array(s),n=0;n<s;n++)i[n]=arguments[n];return e=t.call.apply(t,[this].concat(i))||this,mt(e,"_materials",Yt,pt(e)),mt(e,"_visFlags",Zt,pt(e)),e._materialInstances=[],e._models=[],e}A(e,t);var s=e.prototype;return s.getMaterial=function(t){return t<0||t>=this._materials.length?null:this._materials[t]},s.setMaterial=function(t,e){t&&t instanceof vt&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[e]=t;var s=this._materialInstances[e];s?s.parent!==this._materials[e]&&(s.destroy(),this._materialInstances[e]=null,this._onMaterialModified(e,this._materials[e])):this._onMaterialModified(e,this._materials[e])},s.getMaterialInstance=function(t){if(!this._materials[t])return null;if(!this._materialInstances[t]){se.parent=this._materials[t],se.owner=this,se.subModelIdx=t;var e=new vt(se);this.setMaterialInstance(t,e)}return this._materialInstances[t]},s.setMaterialInstance=function(t,e){e&&e.parent?e!==this._materialInstances[t]&&(this._materialInstances[t]=e,this._onMaterialModified(t,e)):e!==this._materials[t]&&this.setMaterial(e,t)},s.getRenderMaterial=function(t){return this._materialInstances[t]||this._materials[t]},s._collectModels=function(){return this._models},s._attachToScene=function(){},s._detachFromScene=function(){},s._onMaterialModified=function(){},s._onRebuildPSO=function(){},s._clearMaterials=function(){},s._onVisibilityChange=function(){},l(e,[{key:"visibility",get:function(){return this._visFlags},set:function(t){this._visFlags=t,this._onVisibilityChange(t)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(t){for(var e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(var s=t.length;s<this._materials.length;s++)this.setMaterial(null,s);this._materials.splice(t.length)}}},{key:"materials",get:function(){for(var t=0;t<this._materials.length;t++)this._materialInstances[t]=this.getMaterialInstance(t);return this._materialInstances},set:function(t){var e=t.length-this._materials.length;if(e>0)this._materials.length=t.length,this._materialInstances.length=t.length;else if(e<0)for(var s=this._materials.length-e;s<this._materials.length;++s)this.setMaterialInstance(s,null);for(var i=0;i<this._materialInstances.length;i++)this._materialInstances[i]!=t[i]&&this.setMaterialInstance(i,t[i])}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(t){1===this._materials.length&&this._materials[0]===t||this.setMaterialInstance(0,t)}}]),e}(At),Yt=ct((xt=Kt).prototype,"_materials",[kt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zt=ct(xt.prototype,"_visFlags",[St],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return f.Enum.NONE}}),ct(xt.prototype,"sharedMaterials",[Gt,Vt,Wt],Object.getOwnPropertyDescriptor(xt.prototype,"sharedMaterials"),xt.prototype),zt=xt))||zt));g.RenderableComponent=ie}}}));
