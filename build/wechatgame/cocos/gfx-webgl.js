System.register(["./fog-c82f3158.js","./screen-b918b2af.js","./webgl-define-f890b6ea.js"],(function(e){"use strict";var t,r,s,a,i,n,l,u,_,c,o,f,h,d,g,E,p,T,S,A,R,C,B,m,x,b,P,v,O,F,G,y,L,I,M,D,N,U,w,k,W,V,H,X,z,K,Y,q,j,Z,Q,J,$,ee,te,re,se,ae,ie,ne,le,ue,_e,ce,oe,fe,he,de,ge,Ee,pe;return{setters:[function(e){t=e.eN,r=e.b1,s=e.b2,a=e.eM,i=e.D,n=e.x,l=e.af,u=e.ab,_=e.ar,c=e.G,o=e.z,f=e.H,h=e.f,d=e.b0,g=e.b6,E=e.K,p=e.Z,T=e.X,S=e.a5,A=e.e,R=e.a6,C=e.a7,B=e.J,m=e.T,x=e.Y,b=e.C,P=e.at,v=e.B,O=e.am,F=e.aa,G=e.u,y=e.bb,L=e.bc,I=e.b3,M=e.bd,D=e.be,N=e.bk,U=e.bl,w=e.bm,k=e.L,W=e.bn,V=e.bo,H=e.bf,X=e.bg,z=e.bi,K=e.b5,Y=e.b7,q=e.bp,j=e.eb,Z=e.A,Q=e.t,J=e.gr,$=e.gu,ee=e.ea,te=e.gs,re=e.F,se=e.aW,ae=e.a9,ie=e.aV,ne=e.au,le=e.I,ue=e.bq,_e=e.br,ce=e.b9,oe=e.d,fe=e.w,he=e.ao,de=e.al,ge=e.ba,Ee=e.l},function(){},function(e){pe=e.W}],execute:function(){var Te=function(e){function i(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuDescriptorSet=null,t}t(i,e);var n=i.prototype;return n.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,r=t.bindings,s=t.descriptorIndices,a=t.descriptorCount;this._buffers=Array(a).fill(null),this._textures=Array(a).fill(null),this._samplers=Array(a).fill(null);var i=[];this._gpuDescriptorSet={gpuDescriptors:i,descriptorIndices:s};for(var n=0;n<r.length;++n)for(var l=r[n],u=0;u<l.count;u++)i.push({type:l.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null});return!0},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)if(e[t].type&r){var a=this._buffers[t];a&&(e[t].gpuBuffer=a.gpuBuffer||a.gpuBufferView)}else e[t].type&s&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},a(i,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),i}(i);function Se(e,t){switch(e){case n.R8:return t.UNSIGNED_BYTE;case n.R8SN:return t.BYTE;case n.R8UI:return t.UNSIGNED_BYTE;case n.R8I:return t.BYTE;case n.R16F:return pe.HALF_FLOAT_OES;case n.R16UI:return t.UNSIGNED_SHORT;case n.R16I:return t.SHORT;case n.R32F:return t.FLOAT;case n.R32UI:return t.UNSIGNED_INT;case n.R32I:return t.INT;case n.RG8:return t.UNSIGNED_BYTE;case n.RG8SN:return t.BYTE;case n.RG8UI:return t.UNSIGNED_BYTE;case n.RG8I:return t.BYTE;case n.RG16F:return pe.HALF_FLOAT_OES;case n.RG16UI:return t.UNSIGNED_SHORT;case n.RG16I:return t.SHORT;case n.RG32F:return t.FLOAT;case n.RG32UI:return t.UNSIGNED_INT;case n.RG32I:return t.INT;case n.RGB8:case n.SRGB8:return t.UNSIGNED_BYTE;case n.RGB8SN:return t.BYTE;case n.RGB8UI:return t.UNSIGNED_BYTE;case n.RGB8I:return t.BYTE;case n.RGB16F:return pe.HALF_FLOAT_OES;case n.RGB16UI:return t.UNSIGNED_SHORT;case n.RGB16I:return t.SHORT;case n.RGB32F:return t.FLOAT;case n.RGB32UI:return t.UNSIGNED_INT;case n.RGB32I:return t.INT;case n.BGRA8:case n.RGBA8:case n.SRGB8_A8:return t.UNSIGNED_BYTE;case n.RGBA8SN:return t.BYTE;case n.RGBA8UI:return t.UNSIGNED_BYTE;case n.RGBA8I:return t.BYTE;case n.RGBA16F:return pe.HALF_FLOAT_OES;case n.RGBA16UI:return t.UNSIGNED_SHORT;case n.RGBA16I:return t.SHORT;case n.RGBA32F:return t.FLOAT;case n.RGBA32UI:return t.UNSIGNED_INT;case n.RGBA32I:return t.INT;case n.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case n.R11G11B10F:return t.FLOAT;case n.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case n.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case n.RGB10A2:return t.UNSIGNED_BYTE;case n.RGB10A2UI:return t.UNSIGNED_INT;case n.RGB9E5:return t.UNSIGNED_BYTE;case n.D16:return t.UNSIGNED_SHORT;case n.D16S8:return pe.UNSIGNED_INT_24_8_WEBGL;case n.D24:return t.UNSIGNED_INT;case n.D24S8:return pe.UNSIGNED_INT_24_8_WEBGL;case n.D32F:return t.UNSIGNED_INT;case n.D32F_S8:return pe.UNSIGNED_INT_24_8_WEBGL;case n.BC1:case n.BC1_SRGB:case n.BC2:case n.BC2_SRGB:case n.BC3:case n.BC3_SRGB:case n.BC4:return t.UNSIGNED_BYTE;case n.BC4_SNORM:return t.BYTE;case n.BC5:return t.UNSIGNED_BYTE;case n.BC5_SNORM:return t.BYTE;case n.BC6H_SF16:case n.BC6H_UF16:return t.FLOAT;case n.BC7:case n.BC7_SRGB:case n.ETC_RGB8:case n.ETC2_RGB8:case n.ETC2_SRGB8:case n.ETC2_RGB8_A1:case n.ETC2_SRGB8_A1:case n.EAC_R11:return t.UNSIGNED_BYTE;case n.EAC_R11SN:return t.BYTE;case n.EAC_RG11:return t.UNSIGNED_BYTE;case n.EAC_RG11SN:return t.BYTE;case n.PVRTC_RGB2:case n.PVRTC_RGBA2:case n.PVRTC_RGB4:case n.PVRTC_RGBA4:case n.PVRTC2_2BPP:case n.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case n.ASTC_RGBA_4x4:case n.ASTC_RGBA_5x4:case n.ASTC_RGBA_5x5:case n.ASTC_RGBA_6x5:case n.ASTC_RGBA_6x6:case n.ASTC_RGBA_8x5:case n.ASTC_RGBA_8x6:case n.ASTC_RGBA_8x8:case n.ASTC_RGBA_10x5:case n.ASTC_RGBA_10x6:case n.ASTC_RGBA_10x8:case n.ASTC_RGBA_10x10:case n.ASTC_RGBA_12x10:case n.ASTC_RGBA_12x12:case n.ASTC_SRGBA_4x4:case n.ASTC_SRGBA_5x4:case n.ASTC_SRGBA_5x5:case n.ASTC_SRGBA_6x5:case n.ASTC_SRGBA_6x6:case n.ASTC_SRGBA_8x5:case n.ASTC_SRGBA_8x6:case n.ASTC_SRGBA_8x8:case n.ASTC_SRGBA_10x5:case n.ASTC_SRGBA_10x6:case n.ASTC_SRGBA_10x8:case n.ASTC_SRGBA_10x10:case n.ASTC_SRGBA_12x10:case n.ASTC_SRGBA_12x12:default:return t.UNSIGNED_BYTE}}function Ae(e,t){switch(e){case n.A8:return t.ALPHA;case n.L8:return t.LUMINANCE;case n.LA8:return t.LUMINANCE_ALPHA;case n.RGB8:case n.RGB16F:case n.RGB32F:return t.RGB;case n.BGRA8:case n.RGBA8:case n.RGBA16F:case n.RGBA32F:return t.RGBA;case n.R5G6B5:return t.RGB565;case n.RGB5A1:return t.RGB5_A1;case n.RGBA4:return t.RGBA4;case n.D16:return t.DEPTH_COMPONENT;case n.D16S8:return t.DEPTH_STENCIL;case n.D24:return t.DEPTH_COMPONENT;case n.D24S8:return t.DEPTH_STENCIL;case n.D32F:return t.DEPTH_COMPONENT;case n.D32F_S8:return t.DEPTH_STENCIL;case n.BC1:return pe.COMPRESSED_RGB_S3TC_DXT1_EXT;case n.BC1_ALPHA:return pe.COMPRESSED_RGBA_S3TC_DXT1_EXT;case n.BC1_SRGB:return pe.COMPRESSED_SRGB_S3TC_DXT1_EXT;case n.BC1_SRGB_ALPHA:return pe.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case n.BC2:return pe.COMPRESSED_RGBA_S3TC_DXT3_EXT;case n.BC2_SRGB:return pe.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case n.BC3:return pe.COMPRESSED_RGBA_S3TC_DXT5_EXT;case n.BC3_SRGB:return pe.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case n.ETC_RGB8:return pe.COMPRESSED_RGB_ETC1_WEBGL;case n.ETC2_RGB8:return pe.COMPRESSED_RGB8_ETC2;case n.ETC2_SRGB8:return pe.COMPRESSED_SRGB8_ETC2;case n.ETC2_RGB8_A1:return pe.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case n.ETC2_SRGB8_A1:return pe.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case n.ETC2_RGBA8:return pe.COMPRESSED_RGBA8_ETC2_EAC;case n.ETC2_SRGB8_A8:return pe.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case n.EAC_R11:return pe.COMPRESSED_R11_EAC;case n.EAC_R11SN:return pe.COMPRESSED_SIGNED_R11_EAC;case n.EAC_RG11:return pe.COMPRESSED_RG11_EAC;case n.EAC_RG11SN:return pe.COMPRESSED_SIGNED_RG11_EAC;case n.PVRTC_RGB2:return pe.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case n.PVRTC_RGBA2:return pe.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case n.PVRTC_RGB4:return pe.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case n.PVRTC_RGBA4:return pe.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case n.ASTC_RGBA_4x4:return pe.COMPRESSED_RGBA_ASTC_4x4_KHR;case n.ASTC_RGBA_5x4:return pe.COMPRESSED_RGBA_ASTC_5x4_KHR;case n.ASTC_RGBA_5x5:return pe.COMPRESSED_RGBA_ASTC_5x5_KHR;case n.ASTC_RGBA_6x5:return pe.COMPRESSED_RGBA_ASTC_6x5_KHR;case n.ASTC_RGBA_6x6:return pe.COMPRESSED_RGBA_ASTC_6x6_KHR;case n.ASTC_RGBA_8x5:return pe.COMPRESSED_RGBA_ASTC_8x5_KHR;case n.ASTC_RGBA_8x6:return pe.COMPRESSED_RGBA_ASTC_8x6_KHR;case n.ASTC_RGBA_8x8:return pe.COMPRESSED_RGBA_ASTC_8x8_KHR;case n.ASTC_RGBA_10x5:return pe.COMPRESSED_RGBA_ASTC_10x5_KHR;case n.ASTC_RGBA_10x6:return pe.COMPRESSED_RGBA_ASTC_10x6_KHR;case n.ASTC_RGBA_10x8:return pe.COMPRESSED_RGBA_ASTC_10x8_KHR;case n.ASTC_RGBA_10x10:return pe.COMPRESSED_RGBA_ASTC_10x10_KHR;case n.ASTC_RGBA_12x10:return pe.COMPRESSED_RGBA_ASTC_12x10_KHR;case n.ASTC_RGBA_12x12:return pe.COMPRESSED_RGBA_ASTC_12x12_KHR;case n.ASTC_SRGBA_4x4:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case n.ASTC_SRGBA_5x4:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case n.ASTC_SRGBA_5x5:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case n.ASTC_SRGBA_6x5:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case n.ASTC_SRGBA_6x6:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case n.ASTC_SRGBA_8x5:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case n.ASTC_SRGBA_8x6:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case n.ASTC_SRGBA_8x8:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case n.ASTC_SRGBA_10x5:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case n.ASTC_SRGBA_10x6:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case n.ASTC_SRGBA_10x8:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case n.ASTC_SRGBA_10x10:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case n.ASTC_SRGBA_12x10:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case n.ASTC_SRGBA_12x12:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}function Re(e,t){switch(e){case n.A8:return t.ALPHA;case n.L8:return t.LUMINANCE;case n.LA8:return t.LUMINANCE_ALPHA;case n.RGB8:case n.RGB16F:case n.RGB32F:return t.RGB;case n.BGRA8:case n.RGBA8:case n.RGBA16F:case n.RGBA32F:return t.RGBA;case n.R5G6B5:return t.RGB;case n.RGB5A1:case n.RGBA4:return t.RGBA;case n.D16:return t.DEPTH_COMPONENT;case n.D16S8:return t.DEPTH_STENCIL;case n.D24:return t.DEPTH_COMPONENT;case n.D24S8:return t.DEPTH_STENCIL;case n.D32F:return t.DEPTH_COMPONENT;case n.D32F_S8:return t.DEPTH_STENCIL;case n.BC1:return pe.COMPRESSED_RGB_S3TC_DXT1_EXT;case n.BC1_ALPHA:return pe.COMPRESSED_RGBA_S3TC_DXT1_EXT;case n.BC1_SRGB:return pe.COMPRESSED_SRGB_S3TC_DXT1_EXT;case n.BC1_SRGB_ALPHA:return pe.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case n.BC2:return pe.COMPRESSED_RGBA_S3TC_DXT3_EXT;case n.BC2_SRGB:return pe.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case n.BC3:return pe.COMPRESSED_RGBA_S3TC_DXT5_EXT;case n.BC3_SRGB:return pe.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case n.ETC_RGB8:return pe.COMPRESSED_RGB_ETC1_WEBGL;case n.ETC2_RGB8:return pe.COMPRESSED_RGB8_ETC2;case n.ETC2_SRGB8:return pe.COMPRESSED_SRGB8_ETC2;case n.ETC2_RGB8_A1:return pe.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case n.ETC2_SRGB8_A1:return pe.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case n.ETC2_RGBA8:return pe.COMPRESSED_RGBA8_ETC2_EAC;case n.ETC2_SRGB8_A8:return pe.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case n.EAC_R11:return pe.COMPRESSED_R11_EAC;case n.EAC_R11SN:return pe.COMPRESSED_SIGNED_R11_EAC;case n.EAC_RG11:return pe.COMPRESSED_RG11_EAC;case n.EAC_RG11SN:return pe.COMPRESSED_SIGNED_RG11_EAC;case n.PVRTC_RGB2:return pe.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case n.PVRTC_RGBA2:return pe.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case n.PVRTC_RGB4:return pe.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case n.PVRTC_RGBA4:return pe.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case n.ASTC_RGBA_4x4:return pe.COMPRESSED_RGBA_ASTC_4x4_KHR;case n.ASTC_RGBA_5x4:return pe.COMPRESSED_RGBA_ASTC_5x4_KHR;case n.ASTC_RGBA_5x5:return pe.COMPRESSED_RGBA_ASTC_5x5_KHR;case n.ASTC_RGBA_6x5:return pe.COMPRESSED_RGBA_ASTC_6x5_KHR;case n.ASTC_RGBA_6x6:return pe.COMPRESSED_RGBA_ASTC_6x6_KHR;case n.ASTC_RGBA_8x5:return pe.COMPRESSED_RGBA_ASTC_8x5_KHR;case n.ASTC_RGBA_8x6:return pe.COMPRESSED_RGBA_ASTC_8x6_KHR;case n.ASTC_RGBA_8x8:return pe.COMPRESSED_RGBA_ASTC_8x8_KHR;case n.ASTC_RGBA_10x5:return pe.COMPRESSED_RGBA_ASTC_10x5_KHR;case n.ASTC_RGBA_10x6:return pe.COMPRESSED_RGBA_ASTC_10x6_KHR;case n.ASTC_RGBA_10x8:return pe.COMPRESSED_RGBA_ASTC_10x8_KHR;case n.ASTC_RGBA_10x10:return pe.COMPRESSED_RGBA_ASTC_10x10_KHR;case n.ASTC_RGBA_12x10:return pe.COMPRESSED_RGBA_ASTC_12x10_KHR;case n.ASTC_RGBA_12x12:return pe.COMPRESSED_RGBA_ASTC_12x12_KHR;case n.ASTC_SRGBA_4x4:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case n.ASTC_SRGBA_5x4:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case n.ASTC_SRGBA_5x5:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case n.ASTC_SRGBA_6x5:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case n.ASTC_SRGBA_6x6:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case n.ASTC_SRGBA_8x5:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case n.ASTC_SRGBA_8x6:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case n.ASTC_SRGBA_8x8:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case n.ASTC_SRGBA_10x5:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case n.ASTC_SRGBA_10x6:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case n.ASTC_SRGBA_10x8:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case n.ASTC_SRGBA_10x10:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case n.ASTC_SRGBA_12x10:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case n.ASTC_SRGBA_12x12:return pe.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}function Ce(e,t){switch(e){case m.BOOL:return t.BOOL;case m.BOOL2:return t.BOOL_VEC2;case m.BOOL3:return t.BOOL_VEC3;case m.BOOL4:return t.BOOL_VEC4;case m.INT:return t.INT;case m.INT2:return t.INT_VEC2;case m.INT3:return t.INT_VEC3;case m.INT4:return t.INT_VEC4;case m.UINT:return t.UNSIGNED_INT;case m.FLOAT:return t.FLOAT;case m.FLOAT2:return t.FLOAT_VEC2;case m.FLOAT3:return t.FLOAT_VEC3;case m.FLOAT4:return t.FLOAT_VEC4;case m.MAT2:return t.FLOAT_MAT2;case m.MAT3:return t.FLOAT_MAT3;case m.MAT4:return t.FLOAT_MAT4;case m.SAMPLER2D:return t.SAMPLER_2D;case m.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),m.UNKNOWN}}function Be(e){switch(e){case m.BOOL:case m.BOOL2:case m.BOOL3:case m.BOOL4:case m.INT:case m.INT2:case m.INT3:case m.INT4:case m.UINT:return Int32Array;case m.FLOAT:case m.FLOAT2:case m.FLOAT3:case m.FLOAT4:case m.MAT2:case m.MAT3:case m.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function me(e,t){switch(e){case t.BOOL:return m.BOOL;case t.BOOL_VEC2:return m.BOOL2;case t.BOOL_VEC3:return m.BOOL3;case t.BOOL_VEC4:return m.BOOL4;case t.INT:return m.INT;case t.INT_VEC2:return m.INT2;case t.INT_VEC3:return m.INT3;case t.INT_VEC4:return m.INT4;case t.UNSIGNED_INT:return m.UINT;case t.FLOAT:return m.FLOAT;case t.FLOAT_VEC2:return m.FLOAT2;case t.FLOAT_VEC3:return m.FLOAT3;case t.FLOAT_VEC4:return m.FLOAT4;case t.FLOAT_MAT2:return m.MAT2;case t.FLOAT_MAT3:return m.MAT3;case t.FLOAT_MAT4:return m.MAT4;case t.SAMPLER_2D:return m.SAMPLER2D;case t.SAMPLER_CUBE:return m.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),m.UNKNOWN}}function xe(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function be(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}var Pe,ve=[512,513,514,515,516,517,518,519],Oe=[0,7680,7681,7682,7683,5386,34055,34056],Fe=[32774,32778,32779,32775,32776],Ge=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(Pe||(Pe={}));var ye=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},Le=function(e){function r(){var t;return(t=e.call(this,Pe.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new l,t.clearFlag=u.NONE,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return t(r,e),r.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},r}(ye),Ie=function(e){function r(){var t;return(t=e.call(this,Pe.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.viewport=null,t.scissor=null,t.lineWidth=null,t.depthBias=null,t.blendConstants=[],t.depthBounds=null,t.stencilWriteMask=null,t.stencilCompareMask=null,t}return t(r,e),r.prototype.clear=function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0,this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants.length=0,this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null},r}(ye),Me=function(e){function r(){var t;return(t=e.call(this,Pe.DRAW)||this).drawInfo=new _,t}return t(r,e),r.prototype.clear=function(){},r}(ye),De=function(e){function r(){var t;return(t=e.call(this,Pe.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return t(r,e),r.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},r}(ye),Ne=function(e){function r(){var t;return(t=e.call(this,Pe.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return t(r,e),r.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},r}(ye),Ue=function(){function e(){this.cmds=new b(1),this.beginRenderPassCmds=new b(1),this.bindStatesCmds=new b(1),this.drawCmds=new b(1),this.updateBufferCmds=new b(1),this.copyBufferToTextureCmds=new b(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function we(e,t,r,s,a){if(t.usage&o.UNIFORM)ArrayBuffer.isView(r)?t.vf32.set(r,s/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(r),s/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&o.INDIRECT)t.indirects.length=s,Array.prototype.push.apply(t.indirects,r.drawInfos);else{var i=r,n=e.gl,l=e.stateCache;switch(t.glTarget){case n.ARRAY_BUFFER:e.useVAO&&l.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=ke.gpuInputAssembler=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case n.ELEMENT_ARRAY_BUFFER:e.useVAO&&l.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=ke.gpuInputAssembler=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}a===i.byteLength?n.bufferSubData(t.glTarget,s,i):n.bufferSubData(t.glTarget,s,i.slice(0,a))}}var ke={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0};function We(e,t,r,s,a,i,l){var u=e.gl,_=e.stateCache,c=0;if(r&&t){_.glFramebuffer!==r.glFramebuffer&&(u.bindFramebuffer(u.FRAMEBUFFER,r.glFramebuffer),_.glFramebuffer=r.glFramebuffer),_.viewport.left===s.x&&_.viewport.top===s.y&&_.viewport.width===s.width&&_.viewport.height===s.height||(u.viewport(s.x,s.y,s.width,s.height),_.viewport.left=s.x,_.viewport.top=s.y,_.viewport.width=s.width,_.viewport.height=s.height),_.scissorRect.x===s.x&&_.scissorRect.y===s.y&&_.scissorRect.width===s.width&&_.scissorRect.height===s.height||(u.scissor(s.x,s.y,s.width,s.height),_.scissorRect.x=s.x,_.scissorRect.y=s.y,_.scissorRect.width=s.width,_.scissorRect.height=s.height);var o=a.length;e.WEBGL_draw_buffers||(o=1);for(var f=0;f<o;++f){var h=t.colorAttachments[f];if(h.format!==n.UNKNOWN)switch(h.loadOp){case p.LOAD:break;case p.CLEAR:_.bs.targets[0].blendColorMask!==T.ALL&&u.colorMask(!0,!0,!0,!0);var g=a[0];u.clearColor(g.x,g.y,g.z,g.w),c|=u.COLOR_BUFFER_BIT;break;case p.DISCARD:}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==n.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case p.LOAD:break;case p.CLEAR:_.dss.depthWrite||u.depthMask(!0),u.clearDepth(i),c|=u.DEPTH_BUFFER_BIT;break;case p.DISCARD:}if(d[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case p.LOAD:break;case p.CLEAR:_.dss.stencilWriteMaskFront||u.stencilMaskSeparate(u.FRONT,65535),_.dss.stencilWriteMaskBack||u.stencilMaskSeparate(u.BACK,65535),u.clearStencil(l),c|=u.STENCIL_BUFFER_BIT;break;case p.DISCARD:}}if(c&&u.clear(c),c&u.COLOR_BUFFER_BIT){var E=_.bs.targets[0].blendColorMask;if(E!==T.ALL){var S=(E&T.R)!==T.NONE,A=(E&T.G)!==T.NONE,R=(E&T.B)!==T.NONE,C=(E&T.A)!==T.NONE;u.colorMask(S,A,R,C)}}c&u.DEPTH_BUFFER_BIT&&!_.dss.depthWrite&&u.depthMask(!1),c&u.STENCIL_BUFFER_BIT&&(_.dss.stencilWriteMaskFront||u.stencilMaskSeparate(u.FRONT,0),_.dss.stencilWriteMaskBack||u.stencilMaskSeparate(u.BACK,0))}}function Ve(e,t,r,s,a,i,n,l,u,_,c,o,f){var h,d,g,E=e.gl,p=e.stateCache,B=t&&t.gpuShader,m=!1;if(t&&ke.gpuPipelineState!==t){if(ke.gpuPipelineState=t,ke.glPrimitive=t.glPrimitive,t.gpuShader){var x=t.gpuShader.glProgram;p.glProgram!==x&&(E.useProgram(x),p.glProgram=x,m=!0)}var b=t.rs;if(b){if(p.rs.cullMode!==b.cullMode){switch(b.cullMode){case S.NONE:E.disable(E.CULL_FACE);break;case S.FRONT:E.enable(E.CULL_FACE),E.cullFace(E.FRONT);break;case S.BACK:E.enable(E.CULL_FACE),E.cullFace(E.BACK)}p.rs.cullMode=b.cullMode}var P=b.isFrontFaceCCW;p.rs.isFrontFaceCCW!==P&&(E.frontFace(P?E.CCW:E.CW),p.rs.isFrontFaceCCW=P),p.rs.depthBias===b.depthBias&&p.rs.depthBiasSlop===b.depthBiasSlop||(E.polygonOffset(b.depthBias,b.depthBiasSlop),p.rs.depthBias=b.depthBias,p.rs.depthBiasSlop=b.depthBiasSlop),p.rs.lineWidth!==b.lineWidth&&(E.lineWidth(b.lineWidth),p.rs.lineWidth=b.lineWidth)}var v=t.dss;v&&(p.dss.depthTest!==v.depthTest&&(v.depthTest?E.enable(E.DEPTH_TEST):E.disable(E.DEPTH_TEST),p.dss.depthTest=v.depthTest),p.dss.depthWrite!==v.depthWrite&&(E.depthMask(v.depthWrite),p.dss.depthWrite=v.depthWrite),p.dss.depthFunc!==v.depthFunc&&(E.depthFunc(ve[v.depthFunc]),p.dss.depthFunc=v.depthFunc),p.dss.stencilTestFront===v.stencilTestFront&&p.dss.stencilTestBack===v.stencilTestBack||(v.stencilTestFront||v.stencilTestBack?E.enable(E.STENCIL_TEST):E.disable(E.STENCIL_TEST),p.dss.stencilTestFront=v.stencilTestFront,p.dss.stencilTestBack=v.stencilTestBack),p.dss.stencilFuncFront===v.stencilFuncFront&&p.dss.stencilRefFront===v.stencilRefFront&&p.dss.stencilReadMaskFront===v.stencilReadMaskFront||(E.stencilFuncSeparate(E.FRONT,ve[v.stencilFuncFront],v.stencilRefFront,v.stencilReadMaskFront),p.dss.stencilFuncFront=v.stencilFuncFront,p.dss.stencilRefFront=v.stencilRefFront,p.dss.stencilReadMaskFront=v.stencilReadMaskFront),p.dss.stencilFailOpFront===v.stencilFailOpFront&&p.dss.stencilZFailOpFront===v.stencilZFailOpFront&&p.dss.stencilPassOpFront===v.stencilPassOpFront||(E.stencilOpSeparate(E.FRONT,Oe[v.stencilFailOpFront],Oe[v.stencilZFailOpFront],Oe[v.stencilPassOpFront]),p.dss.stencilFailOpFront=v.stencilFailOpFront,p.dss.stencilZFailOpFront=v.stencilZFailOpFront,p.dss.stencilPassOpFront=v.stencilPassOpFront),p.dss.stencilWriteMaskFront!==v.stencilWriteMaskFront&&(E.stencilMaskSeparate(E.FRONT,v.stencilWriteMaskFront),p.dss.stencilWriteMaskFront=v.stencilWriteMaskFront),p.dss.stencilFuncBack===v.stencilFuncBack&&p.dss.stencilRefBack===v.stencilRefBack&&p.dss.stencilReadMaskBack===v.stencilReadMaskBack||(E.stencilFuncSeparate(E.BACK,ve[v.stencilFuncBack],v.stencilRefBack,v.stencilReadMaskBack),p.dss.stencilFuncBack=v.stencilFuncBack,p.dss.stencilRefBack=v.stencilRefBack,p.dss.stencilReadMaskBack=v.stencilReadMaskBack),p.dss.stencilFailOpBack===v.stencilFailOpBack&&p.dss.stencilZFailOpBack===v.stencilZFailOpBack&&p.dss.stencilPassOpBack===v.stencilPassOpBack||(E.stencilOpSeparate(E.BACK,Oe[v.stencilFailOpBack],Oe[v.stencilZFailOpBack],Oe[v.stencilPassOpBack]),p.dss.stencilFailOpBack=v.stencilFailOpBack,p.dss.stencilZFailOpBack=v.stencilZFailOpBack,p.dss.stencilPassOpBack=v.stencilPassOpBack),p.dss.stencilWriteMaskBack!==v.stencilWriteMaskBack&&(E.stencilMaskSeparate(E.BACK,v.stencilWriteMaskBack),p.dss.stencilWriteMaskBack=v.stencilWriteMaskBack));var O=t.bs;if(O){p.bs.isA2C!==O.isA2C&&(O.isA2C?E.enable(E.SAMPLE_ALPHA_TO_COVERAGE):E.disable(E.SAMPLE_ALPHA_TO_COVERAGE),p.bs.isA2C=O.isA2C),p.bs.blendColor.x===O.blendColor.x&&p.bs.blendColor.y===O.blendColor.y&&p.bs.blendColor.z===O.blendColor.z&&p.bs.blendColor.w===O.blendColor.w||(E.blendColor(O.blendColor.x,O.blendColor.y,O.blendColor.z,O.blendColor.w),p.bs.blendColor.x=O.blendColor.x,p.bs.blendColor.y=O.blendColor.y,p.bs.blendColor.z=O.blendColor.z,p.bs.blendColor.w=O.blendColor.w);var F=O.targets[0],G=p.bs.targets[0];G.blend!==F.blend&&(F.blend?E.enable(E.BLEND):E.disable(E.BLEND),G.blend=F.blend),G.blendEq===F.blendEq&&G.blendAlphaEq===F.blendAlphaEq||(E.blendEquationSeparate(Fe[F.blendEq],Fe[F.blendAlphaEq]),G.blendEq=F.blendEq,G.blendAlphaEq=F.blendAlphaEq),G.blendSrc===F.blendSrc&&G.blendDst===F.blendDst&&G.blendSrcAlpha===F.blendSrcAlpha&&G.blendDstAlpha===F.blendDstAlpha||(E.blendFuncSeparate(Ge[F.blendSrc],Ge[F.blendDst],Ge[F.blendSrcAlpha],Ge[F.blendDstAlpha]),G.blendSrc=F.blendSrc,G.blendDst=F.blendDst,G.blendSrcAlpha=F.blendSrcAlpha,G.blendDstAlpha=F.blendDstAlpha),G.blendColorMask!==F.blendColorMask&&(E.colorMask((F.blendColorMask&T.R)!==T.NONE,(F.blendColorMask&T.G)!==T.NONE,(F.blendColorMask&T.B)!==T.NONE,(F.blendColorMask&T.A)!==T.NONE),G.blendColorMask=F.blendColorMask)}}if(t&&t.gpuPipelineLayout&&B){for(var y=B.glBlocks.length,L=t.gpuPipelineLayout.dynamicOffsetIndices,I=0;I<y;I++){var M=B.glBlocks[I],D=s[M.set],N=D&&D.descriptorIndices[M.binding],U=N>=0&&D.gpuDescriptors[N],w=null,k=0;if(U&&U.gpuBuffer){var W=U.gpuBuffer,V=L[M.set],H=V&&V[M.binding];H>=0&&(k=a[H]),"vf32"in W?w=W.vf32:(k+=W.offset,w=W.gpuBuffer.vf32),k>>=2}if(w)for(var X=M.glActiveUniforms.length,z=0;z<X;z++){var K=M.glActiveUniforms[z];switch(K.glType){case E.BOOL:case E.INT:for(var Y=0;Y<K.array.length;++Y){var q=K.begin+k+Y;if(w[q]!==K.array[Y]){for(var j=Y,Z=q;j<K.array.length;++j,++Z)K.array[j]=w[Z];E.uniform1iv(K.glLoc,K.array);break}}break;case E.BOOL_VEC2:case E.INT_VEC2:for(var Q=0;Q<K.array.length;++Q){var J=K.begin+k+Q;if(w[J]!==K.array[Q]){for(var $=Q,ee=J;$<K.array.length;++$,++ee)K.array[$]=w[ee];E.uniform2iv(K.glLoc,K.array);break}}break;case E.BOOL_VEC3:case E.INT_VEC3:for(var te=0;te<K.array.length;++te){var re=K.begin+k+te;if(w[re]!==K.array[te]){for(var se=te,ae=re;se<K.array.length;++se,++ae)K.array[se]=w[ae];E.uniform3iv(K.glLoc,K.array);break}}break;case E.BOOL_VEC4:case E.INT_VEC4:for(var ie=0;ie<K.array.length;++ie){var ne=K.begin+k+ie;if(w[ne]!==K.array[ie]){for(var le=ie,ue=ne;le<K.array.length;++le,++ue)K.array[le]=w[ue];E.uniform4iv(K.glLoc,K.array);break}}break;case E.FLOAT:for(var _e=0;_e<K.array.length;++_e){var ce=K.begin+k+_e;if(w[ce]!==K.array[_e]){for(var oe=_e,fe=ce;oe<K.array.length;++oe,++fe)K.array[oe]=w[fe];E.uniform1fv(K.glLoc,K.array);break}}break;case E.FLOAT_VEC2:for(var he=0;he<K.array.length;++he){var de=K.begin+k+he;if(w[de]!==K.array[he]){for(var ge=he,Ee=de;ge<K.array.length;++ge,++Ee)K.array[ge]=w[Ee];E.uniform2fv(K.glLoc,K.array);break}}break;case E.FLOAT_VEC3:for(var pe=0;pe<K.array.length;++pe){var Te=K.begin+k+pe;if(w[Te]!==K.array[pe]){for(var Se=pe,Ae=Te;Se<K.array.length;++Se,++Ae)K.array[Se]=w[Ae];E.uniform3fv(K.glLoc,K.array);break}}break;case E.FLOAT_VEC4:for(var Re=0;Re<K.array.length;++Re){var Ce=K.begin+k+Re;if(w[Ce]!==K.array[Re]){for(var Be=Re,me=Ce;Be<K.array.length;++Be,++me)K.array[Be]=w[me];E.uniform4fv(K.glLoc,K.array);break}}break;case E.FLOAT_MAT2:for(var xe=0;xe<K.array.length;++xe){var be=K.begin+k+xe;if(w[be]!==K.array[xe]){for(var Pe=xe,ye=be;Pe<K.array.length;++Pe,++ye)K.array[Pe]=w[ye];E.uniformMatrix2fv(K.glLoc,!1,K.array);break}}break;case E.FLOAT_MAT3:for(var Le=0;Le<K.array.length;++Le){var Ie=K.begin+k+Le;if(w[Ie]!==K.array[Le]){for(var Me=Le,De=Ie;Me<K.array.length;++Me,++De)K.array[Me]=w[De];E.uniformMatrix3fv(K.glLoc,!1,K.array);break}}break;case E.FLOAT_MAT4:for(var Ne=0;Ne<K.array.length;++Ne){var Ue=K.begin+k+Ne;if(w[Ue]!==K.array[Ne]){for(var we=Ne,We=Ue;we<K.array.length;++we,++We)K.array[we]=w[We];E.uniformMatrix4fv(K.glLoc,!1,K.array);break}}}}else A("Buffer binding '"+M.name+"' at set "+M.set+" binding "+M.binding+" is not bounded")}for(var Ve=B.glSamplerTextures.length,He=0;He<Ve;He++)for(var Xe=B.glSamplerTextures[He],ze=s[Xe.set],Ke=ze&&ze.descriptorIndices[Xe.binding],Ye=Ke>=0&&ze.gpuDescriptors[Ke],qe=Xe.units.length,je=0;je<qe;je++){var Ze=Xe.units[je];if(Ye&&Ye.gpuSampler){if(Ye.gpuTexture&&Ye.gpuTexture.size>0){var Qe=Ye.gpuTexture,Je=p.glTexUnits[Ze];Je.glTexture!==Qe.glTexture&&(p.texUnit!==Ze&&(E.activeTexture(E.TEXTURE0+Ze),p.texUnit=Ze),Qe.glTexture?E.bindTexture(Qe.glTarget,Qe.glTexture):E.bindTexture(Qe.glTarget,e.nullTex2D.gpuTexture.glTexture),Je.glTexture=Qe.glTexture);var $e=Ye.gpuSampler;Qe.isPowerOf2?(h=$e.glWrapS,d=$e.glWrapT):(h=E.CLAMP_TO_EDGE,d=E.CLAMP_TO_EDGE),g=Qe.isPowerOf2?Qe.mipLevel<=1&&($e.glMinFilter===E.LINEAR_MIPMAP_NEAREST||$e.glMinFilter===E.LINEAR_MIPMAP_LINEAR)?E.LINEAR:$e.glMinFilter:$e.glMinFilter===E.LINEAR||$e.glMinFilter===E.LINEAR_MIPMAP_NEAREST||$e.glMinFilter===E.LINEAR_MIPMAP_LINEAR?E.LINEAR:E.NEAREST,Qe.glWrapS!==h&&(p.texUnit!==Ze&&(E.activeTexture(E.TEXTURE0+Ze),p.texUnit=Ze),E.texParameteri(Qe.glTarget,E.TEXTURE_WRAP_S,h),Qe.glWrapS=h),Qe.glWrapT!==d&&(p.texUnit!==Ze&&(E.activeTexture(E.TEXTURE0+Ze),p.texUnit=Ze),E.texParameteri(Qe.glTarget,E.TEXTURE_WRAP_T,d),Qe.glWrapT=d),Qe.glMinFilter!==g&&(p.texUnit!==Ze&&(E.activeTexture(E.TEXTURE0+Ze),p.texUnit=Ze),E.texParameteri(Qe.glTarget,E.TEXTURE_MIN_FILTER,g),Qe.glMinFilter=g),Qe.glMagFilter!==$e.glMagFilter&&(p.texUnit!==Ze&&(E.activeTexture(E.TEXTURE0+Ze),p.texUnit=Ze),E.texParameteri(Qe.glTarget,E.TEXTURE_MAG_FILTER,$e.glMagFilter),Qe.glMagFilter=$e.glMagFilter)}Ye=ze.gpuDescriptors[++Ke]}else A("Sampler binding '"+Xe.name+"' at set "+Xe.set+" binding "+Xe.binding+" index "+je+" is not bounded")}}if(r&&B&&(m||ke.gpuInputAssembler!==r)){ke.gpuInputAssembler=r;var et=e.ANGLE_instanced_arrays;if(e.useVAO){var tt=e.OES_vertex_array_object,rt=r.glVAOs.get(B.glProgram);if(!rt){var st;rt=tt.createVertexArrayOES(),r.glVAOs.set(B.glProgram,rt),tt.bindVertexArrayOES(rt),E.bindBuffer(E.ARRAY_BUFFER,null),E.bindBuffer(E.ELEMENT_ARRAY_BUFFER,null),p.glArrayBuffer=null,p.glElementArrayBuffer=null;for(var at=B.glInputs.length,it=0;it<at;it++){var nt=B.glInputs[it];st=null;for(var lt=r.glAttribs.length,ut=0;ut<lt;ut++){var _t=r.glAttribs[ut];if(_t.name===nt.name){st=_t;break}}if(st){p.glArrayBuffer!==st.glBuffer&&(E.bindBuffer(E.ARRAY_BUFFER,st.glBuffer),p.glArrayBuffer=st.glBuffer);for(var ct=0;ct<st.componentCount;++ct){var ot=nt.glLoc+ct,ft=st.offset+st.size*ct;E.enableVertexAttribArray(ot),p.glCurrentAttribLocs[ot]=!0,E.vertexAttribPointer(ot,st.count,st.glType,st.isNormalized,st.stride,ft),et&&et.vertexAttribDivisorANGLE(ot,st.isInstanced?1:0)}}}var ht=r.gpuIndexBuffer;ht&&E.bindBuffer(E.ELEMENT_ARRAY_BUFFER,ht.glBuffer),tt.bindVertexArrayOES(null),E.bindBuffer(E.ARRAY_BUFFER,null),E.bindBuffer(E.ELEMENT_ARRAY_BUFFER,null),p.glArrayBuffer=null,p.glElementArrayBuffer=null}p.glVAO!==rt&&(tt.bindVertexArrayOES(rt),p.glVAO=rt)}else{for(var dt=0;dt<e.capabilities.maxVertexAttributes;++dt)p.glCurrentAttribLocs[dt]=!1;for(var gt=B.glInputs.length,Et=0;Et<gt;Et++){for(var pt=B.glInputs[Et],Tt=null,St=r.glAttribs.length,At=0;At<St;At++){var Rt=r.glAttribs[At];if(Rt.name===pt.name){Tt=Rt;break}}if(Tt){p.glArrayBuffer!==Tt.glBuffer&&(E.bindBuffer(E.ARRAY_BUFFER,Tt.glBuffer),p.glArrayBuffer=Tt.glBuffer);for(var Ct=0;Ct<Tt.componentCount;++Ct){var Bt=pt.glLoc+Ct,mt=Tt.offset+Tt.size*Ct;!p.glEnabledAttribLocs[Bt]&&Bt>=0&&(E.enableVertexAttribArray(Bt),p.glEnabledAttribLocs[Bt]=!0),p.glCurrentAttribLocs[Bt]=!0,E.vertexAttribPointer(Bt,Tt.count,Tt.glType,Tt.isNormalized,Tt.stride,mt),et&&et.vertexAttribDivisorANGLE(Bt,Tt.isInstanced?1:0)}}}var xt=r.gpuIndexBuffer;xt&&p.glElementArrayBuffer!==xt.glBuffer&&(E.bindBuffer(E.ELEMENT_ARRAY_BUFFER,xt.glBuffer),p.glElementArrayBuffer=xt.glBuffer);for(var bt=0;bt<e.capabilities.maxVertexAttributes;++bt)p.glEnabledAttribLocs[bt]!==p.glCurrentAttribLocs[bt]&&(E.disableVertexAttribArray(bt),p.glEnabledAttribLocs[bt]=!1)}}if(t&&t.dynamicStates.length)for(var Pt=t.dynamicStates.length,vt=0;vt<Pt;vt++)switch(t.dynamicStates[vt]){case R.VIEWPORT:i&&(p.viewport.left===i.left&&p.viewport.top===i.top&&p.viewport.width===i.width&&p.viewport.height===i.height||(E.viewport(i.left,i.top,i.width,i.height),p.viewport.left=i.left,p.viewport.top=i.top,p.viewport.width=i.width,p.viewport.height=i.height));break;case R.SCISSOR:n&&(p.scissorRect.x===n.x&&p.scissorRect.y===n.y&&p.scissorRect.width===n.width&&p.scissorRect.height===n.height||(E.scissor(n.x,n.y,n.width,n.height),p.scissorRect.x=n.x,p.scissorRect.y=n.y,p.scissorRect.width=n.width,p.scissorRect.height=n.height));break;case R.LINE_WIDTH:l&&p.rs.lineWidth!==l&&(E.lineWidth(l),p.rs.lineWidth=l);break;case R.DEPTH_BIAS:u&&(p.rs.depthBias===u.constantFactor&&p.rs.depthBiasSlop===u.slopeFactor||(E.polygonOffset(u.constantFactor,u.slopeFactor),p.rs.depthBias=u.constantFactor,p.rs.depthBiasSlop=u.slopeFactor));break;case R.BLEND_CONSTANTS:p.bs.blendColor.x===_[0]&&p.bs.blendColor.y===_[1]&&p.bs.blendColor.z===_[2]&&p.bs.blendColor.w===_[3]||(E.blendColor(_[0],_[1],_[2],_[3]),p.bs.blendColor.x=_[0],p.bs.blendColor.y=_[1],p.bs.blendColor.z=_[2],p.bs.blendColor.w=_[3]);break;case R.STENCIL_WRITE_MASK:if(o)switch(o.face){case C.FRONT:p.dss.stencilWriteMaskFront!==o.writeMask&&(E.stencilMaskSeparate(E.FRONT,o.writeMask),p.dss.stencilWriteMaskFront=o.writeMask);break;case C.BACK:p.dss.stencilWriteMaskBack!==o.writeMask&&(E.stencilMaskSeparate(E.BACK,o.writeMask),p.dss.stencilWriteMaskBack=o.writeMask);break;case C.ALL:p.dss.stencilWriteMaskFront===o.writeMask&&p.dss.stencilWriteMaskBack===o.writeMask||(E.stencilMask(o.writeMask),p.dss.stencilWriteMaskFront=o.writeMask,p.dss.stencilWriteMaskBack=o.writeMask)}break;case R.STENCIL_COMPARE_MASK:if(f)switch(f.face){case C.FRONT:p.dss.stencilRefFront===f.reference&&p.dss.stencilReadMaskFront===f.compareMask||(E.stencilFuncSeparate(E.FRONT,ve[p.dss.stencilFuncFront],f.reference,f.compareMask),p.dss.stencilRefFront=f.reference,p.dss.stencilReadMaskFront=f.compareMask);break;case C.BACK:p.dss.stencilRefBack===f.reference&&p.dss.stencilReadMaskBack===f.compareMask||(E.stencilFuncSeparate(E.BACK,ve[p.dss.stencilFuncBack],f.reference,f.compareMask),p.dss.stencilRefBack=f.reference,p.dss.stencilReadMaskBack=f.compareMask);break;case C.ALL:p.dss.stencilRefFront===f.reference&&p.dss.stencilReadMaskFront===f.compareMask&&p.dss.stencilRefBack===f.reference&&p.dss.stencilReadMaskBack===f.compareMask||(E.stencilFunc(ve[p.dss.stencilFuncBack],f.reference,f.compareMask),p.dss.stencilRefFront=f.reference,p.dss.stencilReadMaskFront=f.compareMask,p.dss.stencilRefBack=f.reference,p.dss.stencilReadMaskBack=f.compareMask)}}}function He(e,t){var r=e.gl,s=e.ANGLE_instanced_arrays,a=ke.gpuInputAssembler,i=ke.glPrimitive;if(a)if(a.gpuIndirectBuffer)for(var n=a.gpuIndirectBuffer.indirects.length,l=0;l<n;l++){var u=a.gpuIndirectBuffer.indirects[l],_=a.gpuIndexBuffer;if(u.instanceCount&&s)if(_){if(u.indexCount>0){var c=u.firstIndex*_.stride;s.drawElementsInstancedANGLE(i,u.indexCount,a.glIndexType,c,u.instanceCount)}}else u.vertexCount>0&&s.drawArraysInstancedANGLE(i,u.firstVertex,u.vertexCount,u.instanceCount);else if(_){if(u.indexCount>0){var o=u.firstIndex*_.stride;r.drawElements(i,u.indexCount,a.glIndexType,o)}}else u.vertexCount>0&&r.drawArrays(i,u.firstVertex,u.vertexCount)}else{var f=a.gpuIndexBuffer;if(t.instanceCount&&s)if(f){if(t.indexCount>0){var h=t.firstIndex*f.stride;s.drawElementsInstancedANGLE(i,t.indexCount,a.glIndexType,h,t.instanceCount)}}else t.vertexCount>0&&s.drawArraysInstancedANGLE(i,t.firstVertex,t.vertexCount,t.instanceCount);else if(f){if(t.indexCount>0){var d=t.firstIndex*f.stride;r.drawElements(i,t.indexCount,a.glIndexType,d)}}else t.vertexCount>0&&r.drawArrays(i,t.firstVertex,t.vertexCount)}}var Xe=new Array(Pe.COUNT);function ze(e,t){Xe.fill(0);for(var r=0;r<t.cmds.length;++r){var s=t.cmds.array[r],a=Xe[s]++;switch(s){case Pe.BEGIN_RENDER_PASS:var i=t.beginRenderPassCmds.array[a];We(e,i.gpuRenderPass,i.gpuFramebuffer,i.renderArea,i.clearColors,i.clearDepth,i.clearStencil);break;case Pe.BIND_STATES:var n=t.bindStatesCmds.array[a];Ve(e,n.gpuPipelineState,n.gpuInputAssembler,n.gpuDescriptorSets,n.dynamicOffsets,n.viewport,n.scissor,n.lineWidth,n.depthBias,n.blendConstants,n.depthBounds,n.stencilWriteMask,n.stencilCompareMask);break;case Pe.DRAW:He(e,t.drawCmds.array[a].drawInfo);break;case Pe.UPDATE_BUFFER:var l=t.updateBufferCmds.array[a];we(e,l.gpuBuffer,l.buffer,l.offset,l.size);break;case Pe.COPY_BUFFER_TO_TEXTURE:var u=t.copyBufferToTextureCmds.array[a];Ke(e,u.buffers,u.gpuTexture,u.regions)}}}function Ke(e,t,r,s){var a=e.gl,i=e.stateCache.glTexUnits[e.stateCache.texUnit];i.glTexture!==r.glTexture&&(a.bindTexture(r.glTarget,r.glTexture),i.glTexture=r.glTexture);var n=0,l=1,u=1,_=0,c=d[r.format].isCompressed;switch(r.glTarget){case a.TEXTURE_2D:for(var o=0;o<s.length;o++){var f=s[o];l=f.texExtent.width,u=f.texExtent.height;var h=t[n++];c?r.glInternalFmt===pe.COMPRESSED_RGB_ETC1_WEBGL||e.noCompressedTexSubImage2D?a.compressedTexImage2D(a.TEXTURE_2D,f.texSubres.mipLevel,r.glInternalFmt,l,u,0,h):a.compressedTexSubImage2D(a.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,l,u,r.glFormat,h):a.texSubImage2D(a.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,l,u,r.glFormat,r.glType,h)}break;case a.TEXTURE_CUBE_MAP:for(var g=0;g<s.length;g++){var E=s[g],p=E.texSubres.baseArrayLayer+E.texSubres.layerCount;for(_=E.texSubres.baseArrayLayer;_<p;++_){l=E.texExtent.width,u=E.texExtent.height;var T=t[n++];c?r.glInternalFmt===pe.COMPRESSED_RGB_ETC1_WEBGL||e.noCompressedTexSubImage2D?a.compressedTexImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+_,E.texSubres.mipLevel,r.glInternalFmt,l,u,0,T):a.compressedTexSubImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+_,E.texSubres.mipLevel,E.texOffset.x,E.texOffset.y,l,u,r.glFormat,T):a.texSubImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+_,E.texSubres.mipLevel,E.texOffset.x,E.texOffset.y,l,u,r.glFormat,r.glType,T)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}r.flags&B.GEN_MIPMAP&&a.generateMipmap(r.glTarget)}var Ye=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuBuffer=null,t._gpuBufferView=null,t._uniformBuffer=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBufferView={gpuBuffer:t.gpuBuffer,offset:e.offset,range:e.range}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&o.INDIRECT&&(this._indirectBuffer=new P),this._usage&o.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:[],glTarget:0,glBuffer:null},e.usage&o.INDIRECT&&(this._gpuBuffer.indirects=this._indirectBuffer.drawInfos),this._usage&o.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(e,t){var r=e.gl,s=e.stateCache,a=t.memUsage&c.HOST?r.DYNAMIC_DRAW:r.STATIC_DRAW;if(t.usage&o.VERTEX){t.glTarget=r.ARRAY_BUFFER;var i=r.createBuffer();i&&(t.glBuffer=i,t.size>0&&(e.useVAO&&s.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),s.glVAO=ke.gpuInputAssembler=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),r.bufferData(r.ARRAY_BUFFER,t.size,a),r.bindBuffer(r.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&o.INDEX){t.glTarget=r.ELEMENT_ARRAY_BUFFER;var n=r.createBuffer();n&&(t.glBuffer=n,t.size>0&&(e.useVAO&&s.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),s.glVAO=ke.gpuInputAssembler=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),r.bufferData(r.ELEMENT_ARRAY_BUFFER,t.size,a),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&o.UNIFORM?(t.glTarget=r.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer))):(t.usage&o.INDIRECT||t.usage&o.TRANSFER_DST||t.usage&o.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=r.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size;return!0},s.destroy=function(){var e,t;this._gpuBuffer&&(e=this._device,(t=this._gpuBuffer).glBuffer&&(e.gl.deleteBuffer(t.glBuffer),t.glBuffer=null),this._device.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)},s.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t,r,s,a,i,n=this._size;n!==e&&(this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(e)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=e,e>0&&(t=this._device,r=this._gpuBuffer,s=t.gl,a=t.stateCache,i=r.memUsage&c.HOST?s.DYNAMIC_DRAW:s.STATIC_DRAW,r.usage&o.VERTEX?(t.useVAO&&a.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),a.glVAO=ke.gpuInputAssembler=null),t.stateCache.glArrayBuffer!==r.glBuffer&&s.bindBuffer(s.ARRAY_BUFFER,r.glBuffer),r.buffer?s.bufferData(s.ARRAY_BUFFER,r.buffer,i):s.bufferData(s.ARRAY_BUFFER,r.size,i),s.bindBuffer(s.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null):r.usage&o.INDEX?(t.useVAO&&a.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),a.glVAO=ke.gpuInputAssembler=null),t.stateCache.glElementArrayBuffer!==r.glBuffer&&s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,r.glBuffer),r.buffer?s.bufferData(s.ELEMENT_ARRAY_BUFFER,r.buffer,i):s.bufferData(s.ELEMENT_ARRAY_BUFFER,r.size,i),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):r.usage&o.UNIFORM?r.buffer&&(r.vf32=new Float32Array(r.buffer.buffer)):(r.usage&o.INDIRECT||r.usage&o.TRANSFER_DST||r.usage&o.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),r.glTarget=s.NONE),this._device.memoryStatus.bufferSize-=n,this._device.memoryStatus.bufferSize+=e)))}},s.update=function(e,t){var r;this._isBufferView?console.warn("cannot update through buffer views!"):(r=void 0!==t?t:this._usage&o.INDIRECT?0:e.byteLength,we(this._device,this._gpuBuffer,e,0,r))},a(r,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}}]),r}(v),qe=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new b(t);for(var r=0;r<t;++r)this._frees[r]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,r=this._frees;this._frees=new Array(t);for(var s=t-r.length,a=0;a<s;++a)this._frees[a]=new e;for(var i=s,n=0;i<t;++i,++n)this._frees[i]=r[n];this._freeIdx+=s}var l=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++l.refCount,l},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),je=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new qe(Le,1),this.bindStatesCmdPool=new qe(Ie,1),this.drawCmdPool=new qe(Me,1),this.updateBufferCmdPool=new qe(De,1),this.copyBufferToTextureCmdPool=new qe(Ne,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),Ze=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this).cmdPackage=new Ue,t._webGLAllocator=null,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUInputAssembler=null,t._curGPUDescriptorSets=[],t._curDynamicOffsets=[],t._curViewport=null,t._curScissor=null,t._curLineWidth=null,t._curDepthBias=null,t._curBlendConstants=[],t._curDepthBounds=null,t._curStencilWriteMask=null,t._curStencilCompareMask=null,t._isStateInvalied=!1,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._type=e.type,this._queue=e.queue,this._webGLAllocator=this._device.cmdAllocator;for(var t=this._device.bindingMappingInfo.bufferOffsets.length,r=0;r<t;r++)this._curGPUDescriptorSets.push(null),this._curDynamicOffsets.push([]);return!0},s.destroy=function(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._webGLAllocator=null)},s.begin=function(){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0;for(var e=0;e<this._curDynamicOffsets.length;e++)this._curDynamicOffsets[e].length=0;this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants.length=0,this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},s.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},s.beginRenderPass=function(e,t,r,s,a,i){var n=this._webGLAllocator.beginRenderPassCmdPool.alloc(Le);n.gpuRenderPass=e.gpuRenderPass,n.gpuFramebuffer=t.gpuFramebuffer,n.renderArea=r,n.clearColors.length=s.length;for(var l=0;l<s.length;++l)n.clearColors[l]=s[l];n.clearDepth=a,n.clearStencil=i,this.cmdPackage.beginRenderPassCmds.push(n),this.cmdPackage.cmds.push(Pe.BEGIN_RENDER_PASS),this._isInRenderPass=!0},s.endRenderPass=function(){this._isInRenderPass=!1},s.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},s.bindDescriptorSet=function(e,t,r){var s=t.gpuDescriptorSet;if(s!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=s,this._isStateInvalied=!0),r){for(var a=this._curDynamicOffsets[e],i=0;i<r.length;i++)a[i]=r[i];a.length=r.length,this._isStateInvalied=!0}},s.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},s.setViewport=function(e){this._curViewport?this._curViewport.left===e.left&&this._curViewport.top===e.top&&this._curViewport.width===e.width&&this._curViewport.height===e.height&&this._curViewport.minDepth===e.minDepth&&this._curViewport.maxDepth===e.maxDepth||(this._curViewport.left=e.left,this._curViewport.top=e.top,this._curViewport.width=e.width,this._curViewport.height=e.height,this._curViewport.minDepth=e.minDepth,this._curViewport.maxDepth=e.maxDepth,this._isStateInvalied=!0):this._curViewport=new O(e.left,e.top,e.width,e.height,e.minDepth,e.maxDepth)},s.setScissor=function(e){this._curScissor?this._curScissor.x===e.x&&this._curScissor.y===e.y&&this._curScissor.width===e.width&&this._curScissor.height===e.height||(this._curScissor.x=e.x,this._curScissor.y=e.y,this._curScissor.width=e.width,this._curScissor.height=e.height,this._isStateInvalied=!0):this._curScissor=new l(e.x,e.y,e.width,e.height)},s.setLineWidth=function(e){this._curLineWidth!==e&&(this._curLineWidth=e,this._isStateInvalied=!0)},s.setDepthBias=function(e,t,r){this._curDepthBias?this._curDepthBias.constantFactor===e&&this._curDepthBias.clamp===t&&this._curDepthBias.slopeFactor===r||(this._curDepthBias.constantFactor=e,this._curDepthBias.clamp=t,this._curDepthBias.slopeFactor=r,this._isStateInvalied=!0):(this._curDepthBias={constantFactor:e,clamp:t,slopeFactor:r},this._isStateInvalied=!0)},s.setBlendConstants=function(e){4!==e.length||this._curBlendConstants[0]===e[0]&&this._curBlendConstants[1]===e[1]&&this._curBlendConstants[2]===e[2]&&this._curBlendConstants[3]===e[3]||(this._curBlendConstants.length=0,Array.prototype.push.apply(this._curBlendConstants,e),this._isStateInvalied=!0)},s.setDepthBound=function(e,t){this._curDepthBounds&&this._curDepthBounds.minBounds===e&&this._curDepthBounds.maxBounds===t||(this._curDepthBounds={minBounds:e,maxBounds:t},this._isStateInvalied=!0)},s.setStencilWriteMask=function(e,t){this._curStencilWriteMask?this._curStencilWriteMask.face===e&&this._curStencilWriteMask.writeMask===t||(this._curStencilWriteMask.face=e,this._curStencilWriteMask.writeMask=t,this._isStateInvalied=!0):(this._curStencilWriteMask={face:e,writeMask:t},this._isStateInvalied=!0)},s.setStencilCompareMask=function(e,t,r){this._curStencilCompareMask?this._curStencilCompareMask.face===e&&this._curStencilCompareMask.reference===t&&this._curStencilCompareMask.compareMask===r||(this._curStencilCompareMask.face=e,this._curStencilCompareMask.reference=t,this._curStencilCompareMask.compareMask=r,this._isStateInvalied=!0):(this._curStencilCompareMask={face:e,reference:t,compareMask:r},this._isStateInvalied=!0)},s.draw=function(e){if(this._type===F.PRIMARY&&this._isInRenderPass||this._type===F.SECONDARY){this._isStateInvalied&&this.bindStates();var t=this._webGLAllocator.drawCmdPool.alloc(Me);t.drawInfo.vertexCount=e.vertexCount,t.drawInfo.firstVertex=e.firstVertex,t.drawInfo.indexCount=e.indexCount,t.drawInfo.firstIndex=e.firstIndex,t.drawInfo.vertexOffset=e.vertexOffset,t.drawInfo.instanceCount=e.instanceCount,t.drawInfo.firstInstance=e.firstInstance,this.cmdPackage.drawCmds.push(t),this.cmdPackage.cmds.push(Pe.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;var r=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=r/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(r-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},s.updateBuffer=function(e,t,r){if(this._type===F.PRIMARY&&!this._isInRenderPass||this._type===F.SECONDARY){var s=e.gpuBuffer;if(s){var a,i=this._webGLAllocator.updateBufferCmdPool.alloc(De),n=0;e.usage&o.INDIRECT||(n=void 0!==r?r:t.byteLength),a=t,i.gpuBuffer=s,i.buffer=a,i.offset=0,i.size=n,this.cmdPackage.updateBufferCmds.push(i),this.cmdPackage.cmds.push(Pe.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},s.copyBuffersToTexture=function(e,t,r){if(this._type===F.PRIMARY&&!this._isInRenderPass||this._type===F.SECONDARY){var s=t.gpuTexture;if(s){var a=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(Ne);a&&(a.gpuTexture=s,a.regions=r,a.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(a),this.cmdPackage.cmds.push(Pe.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},s.execute=function(e,t){for(var r=0;r<t;++r){for(var s=e[r],a=0;a<s.cmdPackage.beginRenderPassCmds.length;++a){var i=s.cmdPackage.beginRenderPassCmds.array[a];++i.refCount,this.cmdPackage.beginRenderPassCmds.push(i)}for(var n=0;n<s.cmdPackage.bindStatesCmds.length;++n){var l=s.cmdPackage.bindStatesCmds.array[n];++l.refCount,this.cmdPackage.bindStatesCmds.push(l)}for(var u=0;u<s.cmdPackage.drawCmds.length;++u){var _=s.cmdPackage.drawCmds.array[u];++_.refCount,this.cmdPackage.drawCmds.push(_)}for(var c=0;c<s.cmdPackage.updateBufferCmds.length;++c){var o=s.cmdPackage.updateBufferCmds.array[c];++o.refCount,this.cmdPackage.updateBufferCmds.push(o)}for(var f=0;f<s.cmdPackage.copyBufferToTextureCmds.length;++f){var h=s.cmdPackage.copyBufferToTextureCmds.array[f];++h.refCount,this.cmdPackage.copyBufferToTextureCmds.push(h)}this.cmdPackage.cmds.concat(s.cmdPackage.cmds.array),this._numDrawCalls+=s._numDrawCalls,this._numInstances+=s._numInstances,this._numTris+=s._numTris}},s.pipelineBarrier=function(){},s.bindStates=function(){var e=this._webGLAllocator.bindStatesCmdPool.alloc(Ie);if(e){e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets);for(var t=0;t<this._curDynamicOffsets.length;t++)Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets[t]);e.gpuInputAssembler=this._curGPUInputAssembler,e.viewport=this._curViewport,e.scissor=this._curScissor,e.lineWidth=this._curLineWidth,e.depthBias=this._curDepthBias,Array.prototype.push.apply(e.blendConstants,this._curBlendConstants),e.depthBounds=this._curDepthBounds,e.stencilWriteMask=this._curStencilWriteMask,e.stencilCompareMask=this._curStencilCompareMask,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(Pe.BIND_STATES),this._isStateInvalied=!1}},a(r,[{key:"webGLDevice",get:function(){return this._device}}]),r}(G),Qe=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuFramebuffer=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null,0!==e.depthStencilMipmapLevel&&console.warn("The mipmap level of th texture image to be attached of depth stencil attachment should be 0. Convert to 0.");for(var t=0;t<e.colorMipmapLevels.length;++t)0!==e.colorMipmapLevels[t]&&console.warn("The mipmap level of th texture image to be attached of color attachment "+t+" should be 0. Convert to 0.");for(var r=[],s=0;s<e.colorTextures.length;++s){var a=e.colorTextures[s];a&&r.push(a.gpuTexture)}var i=null;return e.depthStencilTexture&&(i=e.depthStencilTexture.gpuTexture),this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:r,gpuDepthStencilTexture:i,glFramebuffer:null},function(e,t){if(t.gpuColorTextures.length||t.gpuDepthStencilTexture){var r=e.gl,s=[],a=r.createFramebuffer();if(a){t.glFramebuffer=a,e.stateCache.glFramebuffer!==t.glFramebuffer&&r.bindFramebuffer(r.FRAMEBUFFER,t.glFramebuffer);for(var i=0;i<t.gpuColorTextures.length;++i){var n=t.gpuColorTextures[i];n&&(n.glTexture?r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0+i,n.glTarget,n.glTexture,0):r.framebufferRenderbuffer(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0+i,r.RENDERBUFFER,n.glRenderbuffer),s.push(r.COLOR_ATTACHMENT0+i))}var l=t.gpuDepthStencilTexture;if(l){var u=d[l.format].hasStencil?r.DEPTH_STENCIL_ATTACHMENT:r.DEPTH_ATTACHMENT;l.glTexture?r.framebufferTexture2D(r.FRAMEBUFFER,u,l.glTarget,l.glTexture,0):r.framebufferRenderbuffer(r.FRAMEBUFFER,u,r.RENDERBUFFER,l.glRenderbuffer)}e.WEBGL_draw_buffers&&e.WEBGL_draw_buffers.drawBuffersWEBGL(s);var _=r.checkFramebufferStatus(r.FRAMEBUFFER);if(_!==r.FRAMEBUFFER_COMPLETE)switch(_){case r.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case r.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case r.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case r.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&r.bindFramebuffer(r.FRAMEBUFFER,e.stateCache.glFramebuffer)}}}(this._device,this._gpuFramebuffer),!0},s.destroy=function(){var e,t;this._gpuFramebuffer&&(e=this._device,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null),this._gpuFramebuffer=null)},a(r,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),r}(y),Je=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuInputAssembler=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){if(0===e.vertexBuffers.length)return console.error("InputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._firstIndex=0;else{var t=this._vertexBuffers[0];this._vertexCount=t.size/t.stride,this._firstVertex=0,this._vertexOffset=0}this._instanceCount=0,this._firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var r=new Array(e.vertexBuffers.length),s=0;s<e.vertexBuffers.length;++s){var a=e.vertexBuffers[s];a.gpuBuffer&&(r[s]=a.gpuBuffer)}var i=null,n=0;if(e.indexBuffer&&(i=e.indexBuffer.gpuBuffer))switch(i.stride){case 1:n=5121;break;case 2:n=5123;break;case 4:n=5125;break;default:console.error("Error index buffer stride.")}var l=null;return e.indirectBuffer&&(l=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:r,gpuIndexBuffer:i,gpuIndirectBuffer:l,glAttribs:[],glIndexType:n,glVAOs:new Map},function(e,t){var r=e.gl;t.glAttribs=new Array(t.attributes.length);for(var s=[0,0,0,0,0,0,0,0],a=0;a<t.attributes.length;++a){var i=t.attributes[a],n=void 0!==i.stream?i.stream:0,l=t.gpuVertexBuffers[n],u=Se(i.format,r),_=d[i.format].size;t.glAttribs[a]={name:i.name,glBuffer:l.glBuffer,glType:u,size:_,count:d[i.format].count,stride:l.stride,componentCount:be(u,r),isNormalized:void 0!==i.isNormalized&&i.isNormalized,isInstanced:void 0!==i.isInstanced&&i.isInstanced,offset:s[n]},s[n]+=_}}(this._device,this._gpuInputAssembler),!0},s.destroy=function(){var e=this._device;this._gpuInputAssembler&&e.useVAO&&function(e,t){for(var r=t.glVAOs.values(),s=r.next();!s.done;)e.OES_vertex_array_object.deleteVertexArrayOES(s.value),s=r.next();t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},a(r,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),r}(L),$e=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuDescriptorSetLayout=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,r=-1,s=[],a=0;a<this._bindings.length;a++){var i=this._bindings[a];s.push(t),t+=i.count,i.binding>r&&(r=i.binding)}this._bindingIndices=Array(r+1).fill(-1);for(var n=this._descriptorIndices=Array(r+1).fill(-1),l=0;l<this._bindings.length;l++){var u=this._bindings[l];this._bindingIndices[u.binding]=l,n[u.binding]=s[l]}for(var _=[],c=0;c<this._bindings.length;c++){var o=this._bindings[c];if(o.descriptorType&I)for(var f=0;f<o.count;f++)_.push(o.binding)}return this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:_,descriptorIndices:n,descriptorCount:t},!0},s.destroy=function(){this._bindings.length=0},a(r,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),r}(M),et=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuPipelineLayout=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],r=[],s=0,a=0;a<this._setLayouts.length;a++){for(var i=this._setLayouts[a],n=i.gpuDescriptorSetLayout.dynamicBindings,l=Array(i.bindingIndices.length).fill(-1),u=0;u<n.length;u++){var _=n[u];l[_]<0&&(l[_]=s+u)}r.push(i.gpuDescriptorSetLayout),t.push(l),s+=n.length}return this._gpuPipelineLayout={gpuSetLayouts:r,dynamicOffsetIndices:t,dynamicOffsetCount:s},!0},s.destroy=function(){this._setLayouts.length=0},a(r,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),r}(D),tt=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],rt=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuPipelineState=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var r=e.blendState,s=r.targets;s&&s.forEach((function(e,r){t.setTarget(r,e)})),void 0!==r.isA2C&&(t.isA2C=r.isA2C),void 0!==r.isIndepend&&(t.isIndepend=r.isIndepend),void 0!==r.blendColor&&(t.blendColor=r.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var a=[],i=0;i<31;i++)this._dynamicStates&1<<i&&a.push(1<<i);return this._gpuPipelineState={glPrimitive:tt[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:a},!0},s.destroy=function(){this._gpuPipelineState=null},a(r,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),r}(N),st=[],at=function(e){function r(){return e.apply(this,arguments)||this}t(r,e);var s=r.prototype;return s.beginRenderPass=function(e,t,r,s,a,i){We(this._device,e.gpuRenderPass,t.gpuFramebuffer,r,s,a,i),this._isInRenderPass=!0},s.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates(),He(this._device,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;var t=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=t/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(t-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},s.updateBuffer=function(e,t,r){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var s,a=e.gpuBuffer;a&&(s=void 0!==r?r:e.usage&o.INDIRECT?0:t.byteLength,we(this._device,a,t,0,s))}},s.copyBuffersToTexture=function(e,t,r){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var s=t.gpuTexture;s&&Ke(this._device,e,s,r)}},s.execute=function(e,t){for(var r=0;r<t;++r){var s=e[r];ze(this._device,s.cmdPackage),this._numDrawCalls+=s._numDrawCalls,this._numInstances+=s._numInstances,this._numTris+=s._numTris}},s.bindStates=function(){st.length=0;for(var e=0;e<this._curDynamicOffsets.length;e++)Array.prototype.push.apply(st,this._curDynamicOffsets[e]);Ve(this._device,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,st,this._curViewport,this._curScissor,this._curLineWidth,this._curDepthBias,this._curBlendConstants,this._curDepthBounds,this._curStencilWriteMask,this._curStencilCompareMask),this._isStateInvalied=!1},r}(Ze),it=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}t(r,e);var s=r.prototype;return s.initialize=function(e){return this._type=e.type,!0},s.destroy=function(){},s.submit=function(e){if(!this._isAsync)for(var t=e.length,r=0;r<t;r++){var s=e[r];this.numDrawCalls+=s.numDrawCalls,this.numInstances+=s.numInstances,this.numTris+=s.numTris}},s.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},r}(U),nt=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuRenderPass=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){return this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,e.subpasses&&(this._subpasses=e.subpasses),this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash(),!0},s.destroy=function(){this._gpuRenderPass=null},a(r,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),r}(w),lt=[10497,33648,33071,33071],ut=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuSampler=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._minFilter=e.minFilter,this._magFilter=e.magFilter,this._mipFilter=e.mipFilter,this._addressU=e.addressU,this._addressV=e.addressV,this._addressW=e.addressW,this._maxAnisotropy=e.maxAnisotropy,this._cmpFunc=e.cmpFunc,this._borderColor=e.borderColor,this._mipLODBias=e.mipLODBias;var t,r,s=this._minFilter,a=this._magFilter,i=this._mipFilter;t=s===k.LINEAR||s===k.ANISOTROPIC?i===k.LINEAR||i===k.ANISOTROPIC?9987:i===k.POINT?9985:9729:i===k.LINEAR||i===k.ANISOTROPIC?9986:i===k.POINT?9984:9728,r=a===k.LINEAR||a===k.ANISOTROPIC?9729:9728;var n=lt[this._addressU],l=lt[this._addressV],u=lt[this._addressW];return this._gpuSampler={glMinFilter:t,glMagFilter:r,glWrapS:n,glWrapT:l,glWrapR:u},!0},s.destroy=function(){this._gpuSampler=null},a(r,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),r}(W),_t=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuShader=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks,samplerTextures:e.samplerTextures,gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var r=e.stages[t];this._gpuShader.gpuStages[t]={type:r.stage,source:r.source,glShader:null}}return function(e,t){for(var r=e.gl,s=function(e){var s=t.gpuStages[e],a=0,i="",n=1;switch(s.type){case x.VERTEX:i="VertexShader",a=r.VERTEX_SHADER;break;case x.FRAGMENT:i="FragmentShader",a=r.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var l=r.createShader(a);if(l&&(s.glShader=l,r.shaderSource(s.glShader,s.source),r.compileShader(s.glShader),!r.getShaderParameter(s.glShader,r.COMPILE_STATUS))){console.error(i+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",s.source.replace(/^|\n/g,(function(){return"\n"+n+++" "}))),console.error(r.getShaderInfoLog(s.glShader));for(var u=0;u<t.gpuStages.length;u++){var _=t.gpuStages[e];_.glShader&&(r.deleteShader(_.glShader),_.glShader=null)}return{v:void 0}}},a=0;a<t.gpuStages.length;a++){var i=s(a);if("object"==typeof i)return i.v}var n=r.createProgram();if(n){t.glProgram=n;for(var l=0;l<t.gpuStages.length;l++){var u=t.gpuStages[l];r.attachShader(t.glProgram,u.glShader)}if(r.linkProgram(t.glProgram),e.destroyShadersImmediately)for(var _=0;_<t.gpuStages.length;_++){var c=t.gpuStages[_];c.glShader&&(r.detachShader(t.glProgram,c.glShader),r.deleteShader(c.glShader),c.glShader=null)}if(!r.getProgramParameter(t.glProgram,r.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(r.getProgramInfoLog(t.glProgram));console.info("Shader '"+t.name+"' compilation succeeded.");var o=r.getProgramParameter(t.glProgram,r.ACTIVE_ATTRIBUTES);t.glInputs=new Array(o);for(var f=0;f<o;++f){var h=r.getActiveAttrib(t.glProgram,f);if(h){var d,g=h.name.indexOf("[");d=-1!==g?h.name.substr(0,g):h.name;var E=r.getAttribLocation(t.glProgram,d),p=me(h.type,r),T=xe(h.type,r);t.glInputs[f]={binding:E,name:d,type:p,stride:T,count:h.size,size:T*h.size,glType:h.type,glLoc:E}}}if(t.blocks.length>0){t.glBlocks=new Array(t.blocks.length);for(var S=0;S<t.blocks.length;++S){var A=t.blocks[S],R={set:A.set,binding:A.binding,name:A.name,size:0,glUniforms:new Array(A.members.length),glActiveUniforms:[]};t.glBlocks[S]=R;for(var C=0;C<A.members.length;++C){var B=A.members[C],m=Ce(B.type,r),b=Be(B.type),P=xe(m,r),v=P*B.count,O=R.size/4,F=new b(v/4);R.glUniforms[C]={binding:-1,name:B.name,type:B.type,stride:P,count:B.count,size:v,offset:R.size,glType:m,glLoc:-1,array:F,begin:O},R.size+=v}}}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var G=0;G<t.samplerTextures.length;++G){var y=t.samplerTextures[G];t.glSamplerTextures[G]={set:y.set,binding:y.binding,name:y.name,type:y.type,count:y.count,units:[],glUnits:null,glType:Ce(y.type,r),glLoc:null}}}for(var L=r.getProgramParameter(t.glProgram,r.ACTIVE_UNIFORMS),I=0;I<L;++I){var M=r.getActiveUniform(t.glProgram,I);if(M&&M.type!==r.SAMPLER_2D&&M.type!==r.SAMPLER_CUBE){var D=r.getUniformLocation(t.glProgram,M.name);if(null!==D&&("number"==typeof D||-1!==D.id)){var N,U=M.name.indexOf("[");N=-1!==U?M.name.substr(0,U):M.name;for(var w=0;w<t.glBlocks.length;w++)for(var k=t.glBlocks[w],W=0;W<k.glUniforms.length;W++){var V=k.glUniforms[W];if(V.name===N){V.glLoc=D,k.glActiveUniforms.push(V);break}}}}}for(var H=[],X=[],z=e.bindingMappingInfo,K=e.stateCache.texUnitCacheMap,Y=0,q=0;q<t.blocks.length;++q)t.blocks[q].set===z.flexibleSet&&Y++;for(var j=0,Z=0;Z<t.samplerTextures.length;++Z){var Q=t.samplerTextures[Z],J=r.getUniformLocation(t.glProgram,Q.name);if(null===J||"number"!=typeof J&&-1===J.id||(H.push(t.glSamplerTextures[Z]),X.push(J)),void 0===K[Q.name]){var $=Q.binding+z.samplerOffsets[Q.set]+j;Q.set===z.flexibleSet&&($-=Y),K[Q.name]=$%e.capabilities.maxTextureUnits,j+=Q.count-1}}if(H.length){for(var ee=[],te=0;te<H.length;++te){var re=H[te],se=K[re.name];if(void 0!==se){re.glLoc=X[te];for(var ae=0;ae<re.count;++ae){for(;ee[se];)se=(se+1)%e.capabilities.maxTextureUnits;re.units.push(se),ee[se]=!0}}}for(var ie=0,ne=0;ne<H.length;++ne){var le=H[ne];if(!le.glLoc){le.glLoc=X[ne];for(var ue=0;ue<le.count;++ue){for(;ee[ie];)ie=(ie+1)%e.capabilities.maxTextureUnits;void 0===K[le.name]&&(K[le.name]=ie),le.units.push(ie),ee[ie]=!0}}}e.stateCache.glProgram!==t.glProgram&&r.useProgram(t.glProgram);for(var _e=0;_e<H.length;_e++){var ce=H[_e];ce.glUnits=new Int32Array(ce.units),r.uniform1iv(ce.glLoc,ce.glUnits)}e.stateCache.glProgram!==t.glProgram&&r.useProgram(e.stateCache.glProgram)}for(var oe=0;oe<t.glBlocks.length;)t.glBlocks[oe].glActiveUniforms.length?oe++:(t.glBlocks[oe]=t.glBlocks[t.glBlocks.length-1],t.glBlocks.length--);t.glSamplerTextures=H}}(this._device,this._gpuShader),!0},s.destroy=function(){this._gpuShader&&(function(e,t){if(t.glProgram){var r=e.gl;if(!e.destroyShadersImmediately)for(var s=0;s<t.gpuStages.length;s++){var a=t.gpuStages[s];a.glShader&&(r.detachShader(t.glProgram,a.glShader),r.deleteShader(a.glShader),a.glShader=null)}r.deleteProgram(t.glProgram),t.glProgram=null}}(this._device,this._gpuShader),this._gpuShader=null)},a(r,[{key:"gpuShader",get:function(){return this._gpuShader}}]),r}(V),ct=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new O,this.scissorRect=new l(0,0,0,0),this.rs=new H,this.dss=new X,this.bs=new z,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t){for(var r=0;r<e;++r)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=t,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=t,this.glCurrentAttribLocs.fill(!1)},e}(),ot=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuTexture=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){return"texture"in e?(console.log("WebGL does not support texture view."),!1):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,this._depth=e.depth,this._layerCount=e.layerCount,this._levelCount=e.levelCount,this._samples=e.samples,this._flags=e.flags,this._isPowerOf2=K(this._width)&&K(this._height),this._size=Y(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(e,t){var r=e.gl;t.glInternalFmt=Ae(t.format,r),t.glFormat=Re(t.format,r),t.glType=Se(t.format,r);var s=t.width,a=t.height;switch(t.type){case f.TEX2D:t.glTarget=r.TEXTURE_2D;var i=Math.max(s,a);if(i>e.capabilities.maxTextureSize&&h(9100,i,e.capabilities.maxTextureSize),!e.WEBGL_depth_texture&&d[t.format].hasDepth){var n=r.createRenderbuffer();n&&t.size>0&&(t.glRenderbuffer=n,e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),t.glInternalFmt===r.DEPTH_COMPONENT&&(t.glInternalFmt=r.DEPTH_COMPONENT16),r.renderbufferStorage(r.RENDERBUFFER,t.glInternalFmt,s,a))}else if(t.samples===E.X1){var l=r.createTexture();if(l&&t.size>0){t.glTexture=l;var u=e.stateCache.glTexUnits[e.stateCache.texUnit];if(u.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_2D,t.glTexture),u.glTexture=t.glTexture),d[t.format].isCompressed)if(t.glInternalFmt!==pe.COMPRESSED_RGB_ETC1_WEBGL)for(var _=0;_<t.mipLevel;++_){var c=g(t.format,s,a,1),o=new Uint8Array(c);r.compressedTexImage2D(r.TEXTURE_2D,_,t.glInternalFmt,s,a,0,o),s=Math.max(1,s>>1),a=Math.max(1,a>>1)}else{var p=g(t.format,2,2,1),T=new Uint8Array(p);r.compressedTexImage2D(r.TEXTURE_2D,0,t.glInternalFmt,2,2,0,T)}else for(var S=0;S<t.mipLevel;++S)r.texImage2D(r.TEXTURE_2D,S,t.glInternalFmt,s,a,0,t.glFormat,t.glType,null),s=Math.max(1,s>>1),a=Math.max(1,a>>1);t.isPowerOf2?(t.glWrapS=r.REPEAT,t.glWrapT=r.REPEAT):(t.glWrapS=r.CLAMP_TO_EDGE,t.glWrapT=r.CLAMP_TO_EDGE),t.glMinFilter=r.LINEAR,t.glMagFilter=r.LINEAR,r.texParameteri(t.glTarget,r.TEXTURE_WRAP_S,t.glWrapS),r.texParameteri(t.glTarget,r.TEXTURE_WRAP_T,t.glWrapT),r.texParameteri(t.glTarget,r.TEXTURE_MIN_FILTER,t.glMinFilter),r.texParameteri(t.glTarget,r.TEXTURE_MAG_FILTER,t.glMagFilter)}else r.deleteTexture(l)}break;case f.CUBE:t.glTarget=r.TEXTURE_CUBE_MAP;var A=Math.max(s,a);A>e.capabilities.maxCubeMapTextureSize&&h(9100,A,e.capabilities.maxTextureSize);var R=r.createTexture();if(R&&t.size>0){t.glTexture=R;var C=e.stateCache.glTexUnits[e.stateCache.texUnit];if(C.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,t.glTexture),C.glTexture=t.glTexture),d[t.format].isCompressed)if(t.glInternalFmt!==pe.COMPRESSED_RGB_ETC1_WEBGL)for(var B=0;B<6;++B){s=t.width,a=t.height;for(var m=0;m<t.mipLevel;++m){var x=g(t.format,s,a,1),b=new Uint8Array(x);r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+B,m,t.glInternalFmt,s,a,0,b),s=Math.max(1,s>>1),a=Math.max(1,a>>1)}}else for(var P=0;P<6;++P){var v=g(t.format,2,2,1),O=new Uint8Array(v);r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+P,0,t.glInternalFmt,2,2,0,O)}else for(var F=0;F<6;++F){s=t.width,a=t.height;for(var G=0;G<t.mipLevel;++G)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+F,G,t.glInternalFmt,s,a,0,t.glFormat,t.glType,null),s=Math.max(1,s>>1),a=Math.max(1,a>>1)}t.isPowerOf2?(t.glWrapS=r.REPEAT,t.glWrapT=r.REPEAT):(t.glWrapS=r.CLAMP_TO_EDGE,t.glWrapT=r.CLAMP_TO_EDGE),t.glMinFilter=r.LINEAR,t.glMagFilter=r.LINEAR,r.texParameteri(t.glTarget,r.TEXTURE_WRAP_S,t.glWrapS),r.texParameteri(t.glTarget,r.TEXTURE_WRAP_T,t.glWrapT),r.texParameteri(t.glTarget,r.TEXTURE_MIN_FILTER,t.glMinFilter),r.texParameteri(t.glTarget,r.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=f.TEX2D,t.glTarget=r.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,!0)},s.destroy=function(){var e,t;this._gpuTexture&&(e=this._device,(t=this._gpuTexture).glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},s.resize=function(e,t){var r=this._size;this._width=e,this._height=t,this._size=Y(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){var r=e.gl;t.glInternalFmt=Ae(t.format,r),t.glFormat=Re(t.format,r),t.glType=Se(t.format,r);var s=t.width,a=t.height;switch(t.type){case f.TEX2D:t.glTarget=r.TEXTURE_2D;var i=Math.max(s,a);if(i>e.capabilities.maxTextureSize&&h(9100,i,e.capabilities.maxTextureSize),t.glRenderbuffer)e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),r.renderbufferStorage(r.RENDERBUFFER,t.glInternalFmt,s,a);else if(t.glTexture){var n=e.stateCache.glTexUnits[e.stateCache.texUnit];if(n.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_2D,t.glTexture),n.glTexture=t.glTexture),d[t.format].isCompressed){if(t.glInternalFmt!==pe.COMPRESSED_RGB_ETC1_WEBGL)for(var l=0;l<t.mipLevel;++l){var u=g(t.format,s,a,1),_=new Uint8Array(u);r.compressedTexImage2D(r.TEXTURE_2D,l,t.glInternalFmt,s,a,0,_),s=Math.max(1,s>>1),a=Math.max(1,a>>1)}}else for(var c=0;c<t.mipLevel;++c)r.texImage2D(r.TEXTURE_2D,c,t.glInternalFmt,s,a,0,t.glFormat,t.glType,null),s=Math.max(1,s>>1),a=Math.max(1,a>>1)}break;case f.CUBE:t.glTarget=r.TEXTURE_CUBE_MAP;var o=Math.max(s,a);o>e.capabilities.maxCubeMapTextureSize&&h(9100,o,e.capabilities.maxTextureSize);var E=e.stateCache.glTexUnits[e.stateCache.texUnit];if(E.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,t.glTexture),E.glTexture=t.glTexture),d[t.format].isCompressed){if(t.glInternalFmt!==pe.COMPRESSED_RGB_ETC1_WEBGL)for(var p=0;p<6;++p){s=t.width,a=t.height;for(var T=0;T<t.mipLevel;++T){var S=g(t.format,s,a,1),A=new Uint8Array(S);r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+p,T,t.glInternalFmt,s,a,0,A),s=Math.max(1,s>>1),a=Math.max(1,a>>1)}}}else for(var R=0;R<6;++R){s=t.width,a=t.height;for(var C=0;C<t.mipLevel;++C)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+R,C,t.glInternalFmt,s,a,0,t.glFormat,t.glType,null),s=Math.max(1,s>>1),a=Math.max(1,a>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=f.TEX2D,t.glTarget=r.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=r,this._device.memoryStatus.textureSize+=this._size)},a(r,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),r}(q),ft="webglcontextlost",ht=e("WebGLDevice",function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this).stateCache=new ct,t.cmdAllocator=new je,t.nullTex2D=null,t.nullTexCube=null,t._webGLRC=null,t._isAntialias=!0,t._isPremultipliedAlpha=!0,t._useVAO=!1,t._destroyShadersImmediately=!0,t._noCompressedTexSubImage2D=!1,t._bindingMappingInfo=new he,t._webGLContextLostHandler=null,t._extensions=null,t._EXT_texture_filter_anisotropic=null,t._EXT_blend_minmax=null,t._EXT_frag_depth=null,t._EXT_shader_texture_lod=null,t._EXT_sRGB=null,t._OES_vertex_array_object=null,t._EXT_color_buffer_half_float=null,t._WEBGL_color_buffer_float=null,t._WEBGL_compressed_texture_etc1=null,t._WEBGL_compressed_texture_etc=null,t._WEBGL_compressed_texture_pvrtc=null,t._WEBGL_compressed_texture_astc=null,t._WEBGL_compressed_texture_s3tc=null,t._WEBGL_compressed_texture_s3tc_srgb=null,t._WEBGL_debug_shaders=null,t._WEBGL_draw_buffers=null,t._WEBGL_lose_context=null,t._WEBGL_depth_texture=null,t._WEBGL_debug_renderer_info=null,t._OES_texture_half_float=null,t._OES_texture_half_float_linear=null,t._OES_texture_float=null,t._OES_texture_float_linear=null,t._OES_standard_derivatives=null,t._OES_element_index_uint=null,t._ANGLE_instanced_arrays=null,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._canvas=e.canvasElm,this._isAntialias=e.isAntialias,this._isPremultipliedAlpha=e.isPremultipliedAlpha,this._bindingMappingInfo=e.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);try{var t={alpha:j.ENABLE_TRANSPARENT_CANVAS,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGLRC=this._canvas.getContext("webgl",t)}catch(e){return console.error(e),!1}if(!this._webGLRC)return console.error("This device does not support WebGL."),!1;this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(ft,this._onWebGLContextLost),this._canvas2D=document.createElement("canvas"),console.info("WebGL device initialized."),this._gfxAPI=Z.WEBGL,this._deviceName="WebGL";var r=this._webGLRC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=r.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=r.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=r.getParameter(r.RENDERER),this._vendor=r.getParameter(r.VENDOR)),this._version=r.getParameter(r.VERSION),this._caps.maxVertexAttributes=r.getParameter(r.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=r.getParameter(r.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=r.getParameter(r.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=r.getParameter(r.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=r.getParameter(r.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=r.getParameter(r.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=r.getParameter(r.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.depthBits=r.getParameter(r.DEPTH_BITS),this._caps.stencilBits=r.getParameter(r.STENCIL_BITS),this.stateCache.initialize(this._caps.maxTextureUnits,this._caps.maxVertexAttributes),this._devicePixelRatio=e.devicePixelRatio||1,this._width=this._canvas.width,this._height=this._canvas.height,this._nativeWidth=Math.max(e.nativeWidth||this._width,0),this._nativeHeight=Math.max(e.nativeHeight||this._height,0),this._colorFmt=n.RGBA8,24===this._caps.depthBits?8===this._caps.stencilBits?this._depthStencilFmt=n.D24S8:this._depthStencilFmt=n.D24:8===this._caps.stencilBits?this._depthStencilFmt=n.D16S8:this._depthStencilFmt=n.D16,this._extensions=r.getSupportedExtensions();var s="";if(this._extensions){for(var a,i=Q(this._extensions);!(a=i()).done;)s+=a.value+" ";console.debug("EXTENSIONS: "+s)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_blend_minmax=this.getExtension("EXT_blend_minmax"),this._EXT_frag_depth=this.getExtension("EXT_frag_depth"),this._EXT_shader_texture_lod=this.getExtension("EXT_shader_texture_lod"),this._EXT_sRGB=this.getExtension("EXT_sRGB"),this._OES_vertex_array_object=this.getExtension("OES_vertex_array_object"),this._EXT_color_buffer_half_float=this.getExtension("EXT_color_buffer_half_float"),this._WEBGL_color_buffer_float=this.getExtension("WEBGL_color_buffer_float"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_draw_buffers=this.getExtension("WEBGL_draw_buffers"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._WEBGL_depth_texture=this.getExtension("WEBGL_depth_texture"),this._OES_texture_half_float=this.getExtension("OES_texture_half_float"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._OES_texture_float=this.getExtension("OES_texture_float"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_standard_derivatives=this.getExtension("OES_standard_derivatives"),this._OES_element_index_uint=this.getExtension("OES_element_index_uint"),this._ANGLE_instanced_arrays=this.getExtension("ANGLE_instanced_arrays"),J.os===$.IOS&&14===ee.osMainVersion&&ee.isBrowser||(this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc")),J.browserType===te.UC&&(this._ANGLE_instanced_arrays=null),(J.os===$.IOS&&ee.osMainVersion<=10||J.os===$.ANDROID)&&(this._destroyShadersImmediately=!1),this._noCompressedTexSubImage2D=!0,this._features.fill(!1),this._EXT_blend_minmax&&(this._features[re.BLEND_MINMAX]=!0),this._WEBGL_color_buffer_float&&(this._features[re.COLOR_FLOAT]=!0),this._EXT_color_buffer_half_float&&(this._features[re.COLOR_HALF_FLOAT]=!0),this._OES_texture_float&&(this._features[re.TEXTURE_FLOAT]=!0),this._OES_texture_half_float&&(this._features[re.TEXTURE_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[re.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[re.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._features[re.FORMAT_RGB8]=!0,this._WEBGL_depth_texture&&(this._features[re.FORMAT_D16]=!0,this._features[re.FORMAT_D24]=!0,this._features[re.FORMAT_D24S8]=!0),this._OES_element_index_uint&&(this._features[re.ELEMENT_INDEX_UINT]=!0),this._ANGLE_instanced_arrays&&(this._features[re.INSTANCED_ARRAYS]=!0),this._WEBGL_draw_buffers&&(this._features[re.MULTIPLE_RENDER_TARGETS]=!0);var l="";this._WEBGL_compressed_texture_etc1&&(this._features[re.FORMAT_ETC1]=!0,l+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[re.FORMAT_ETC2]=!0,l+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[re.FORMAT_DXT]=!0,l+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[re.FORMAT_PVRTC]=!0,l+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[re.FORMAT_ASTC]=!0,l+="astc "),this._OES_vertex_array_object&&(this._useVAO=!0),console.info("RENDERER: "+this._renderer),console.info("VENDOR: "+this._vendor),console.info("VERSION: "+this._version),console.info("DPR: "+this._devicePixelRatio),console.info("SCREEN_SIZE: "+this._width+" x "+this._height),console.info("NATIVE_SIZE: "+this._nativeWidth+" x "+this._nativeHeight),console.info("MAX_VERTEX_UNIFORM_VECTORS: "+this._caps.maxVertexUniformVectors),console.info("DEPTH_BITS: "+this._caps.depthBits),console.info("STENCIL_BITS: "+this._caps.stencilBits),this._EXT_texture_filter_anisotropic&&console.info("MAX_TEXTURE_MAX_ANISOTROPY_EXT: "+this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT),console.info("USE_VAO: "+this._useVAO),console.info("COMPRESSED_FORMAT: "+l),this.initStates(r),this._queue=this.createQueue(new se(ae.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new ie(this._queue)),this.nullTex2D=this.createTexture(new ne(f.TEX2D,le.SAMPLED,n.RGBA8,2,2,B.GEN_MIPMAP)),this.nullTexCube=this.createTexture(new ne(f.CUBE,le.SAMPLED,n.RGBA8,2,2,B.GEN_MIPMAP,6));var u=new de;u.texExtent.width=2,u.texExtent.height=2;var _=new Uint8Array(this.nullTex2D.size);return _.fill(0),this.copyBuffersToTexture([_],this.nullTex2D,[u]),u.texSubres.layerCount=6,this.copyBuffersToTexture([_,_,_,_,_,_],this.nullTexCube,[u]),!0},s.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(ft,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null),this._extensions=null,this._webGLRC=null},s.resize=function(e,t){this._width===e&&this._height===t||(console.info("Resizing device: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._width=e,this._height=t)},s.flushCommands=function(){},s.acquire=function(){this.cmdAllocator.releaseCmds()},s.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},s.createCommandBuffer=function(e){var t=new(e.type===F.PRIMARY?at:Ze)(this);return t.initialize(e),t},s.createBuffer=function(e){var t=new Ye(this);return t.initialize(e)?t:null},s.createTexture=function(e){var t=new ot(this);return t.initialize(e)?t:null},s.createSampler=function(e){var t=new ut(this);return t.initialize(e)?t:null},s.createDescriptorSet=function(e){var t=new Te(this);return t.initialize(e)?t:null},s.createShader=function(e){var t=new _t(this);return t.initialize(e)?t:null},s.createInputAssembler=function(e){var t=new Je(this);return t.initialize(e)?t:null},s.createRenderPass=function(e){var t=new nt(this);return t.initialize(e)?t:null},s.createFramebuffer=function(e){var t=new Qe(this);return t.initialize(e)?t:null},s.createDescriptorSetLayout=function(e){var t=new $e(this);return t.initialize(e)?t:null},s.createPipelineLayout=function(e){var t=new et(this);return t.initialize(e)?t:null},s.createPipelineState=function(e){var t=new rt(this);return t.initialize(e)?t:null},s.createQueue=function(e){var t=new it(this);return t.initialize(e)?t:null},s.createGlobalBarrier=function(e){var t=new ue(this);return t.initialize(e)?t:null},s.createTextureBarrier=function(e){var t=new _e(this);return t.initialize(e)?t:null},s.copyBuffersToTexture=function(e,t,r){Ke(this,e,t.gpuTexture,r)},s.copyTexImagesToTexture=function(e,t,r){!function(e,t,r,s){var a=e.gl,i=e.stateCache.glTexUnits[e.stateCache.texUnit];i.glTexture!==r.glTexture&&(a.bindTexture(r.glTarget,r.glTexture),i.glTexture=r.glTexture);var n=0,l=0;switch(r.glTarget){case a.TEXTURE_2D:for(var u=0;u<s.length;u++){var _=s[u];a.texSubImage2D(a.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,r.glFormat,r.glType,t[n++])}break;case a.TEXTURE_CUBE_MAP:for(var c=0;c<s.length;c++){var o=s[c],f=o.texSubres.baseArrayLayer+o.texSubres.layerCount;for(l=o.texSubres.baseArrayLayer;l<f;++l)a.texSubImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+l,o.texSubres.mipLevel,o.texOffset.x,o.texOffset.y,r.glFormat,r.glType,t[n++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}r.flags&B.GEN_MIPMAP&&r.isPowerOf2&&a.generateMipmap(r.glTarget)}(this,e,t.gpuTexture,r)},s.copyFramebufferToBuffer=function(e,t,r){var s=this._webGLRC,a=e.gpuFramebuffer,i=a.gpuColorTextures[0].format,n=Re(i,s),l=Se(i,s),u=ce(d[i]),_=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==a.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,a.glFramebuffer),this.stateCache.glFramebuffer=a.glFramebuffer);for(var c,o=new u(t),f=Q(r);!(c=f()).done;){var h=c.value,g=h.texExtent.width,E=h.texExtent.height;s.readPixels(h.texOffset.x,h.texOffset.y,g,E,n,l,o)}this.stateCache.glFramebuffer!==_&&(s.bindFramebuffer(s.FRAMEBUFFER,_),this.stateCache.glFramebuffer=_)},s.blitFramebuffer=function(){},s.getExtension=function(e){for(var t=["","WEBKIT_","MOZ_"],r=0;r<t.length;++r){var s=this.gl.getExtension(t[r]+e);if(s)return s}return null},s.initStates=function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)},s._onWebGLContextLost=function(e){oe(11e3),fe(e)},a(r,[{key:"gl",get:function(){return this._webGLRC}},{key:"webGLQueue",get:function(){return this._queue}},{key:"isAntialias",get:function(){return this._isAntialias}},{key:"isPremultipliedAlpha",get:function(){return this._isPremultipliedAlpha}},{key:"useVAO",get:function(){return this._useVAO}},{key:"destroyShadersImmediately",get:function(){return this._destroyShadersImmediately}},{key:"noCompressedTexSubImage2D",get:function(){return this._noCompressedTexSubImage2D}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}},{key:"EXT_texture_filter_anisotropic",get:function(){return this._EXT_texture_filter_anisotropic}},{key:"EXT_blend_minmax",get:function(){return this._EXT_blend_minmax}},{key:"EXT_frag_depth",get:function(){return this._EXT_frag_depth}},{key:"EXT_shader_texture_lod",get:function(){return this._EXT_shader_texture_lod}},{key:"EXT_sRGB",get:function(){return this._EXT_sRGB}},{key:"OES_vertex_array_object",get:function(){return this._OES_vertex_array_object}},{key:"WEBGL_color_buffer_float",get:function(){return this._WEBGL_color_buffer_float}},{key:"WEBGL_compressed_texture_etc1",get:function(){return this._WEBGL_compressed_texture_etc1}},{key:"WEBGL_compressed_texture_pvrtc",get:function(){return this._WEBGL_compressed_texture_pvrtc}},{key:"WEBGL_compressed_texture_astc",get:function(){return this._WEBGL_compressed_texture_astc}},{key:"WEBGL_compressed_texture_s3tc",get:function(){return this._WEBGL_compressed_texture_s3tc}},{key:"WEBGL_compressed_texture_s3tc_srgb",get:function(){return this._WEBGL_compressed_texture_s3tc_srgb}},{key:"WEBGL_debug_shaders",get:function(){return this._WEBGL_debug_shaders}},{key:"WEBGL_draw_buffers",get:function(){return this._WEBGL_draw_buffers}},{key:"WEBGL_lose_context",get:function(){return this._WEBGL_lose_context}},{key:"WEBGL_depth_texture",get:function(){return this._WEBGL_depth_texture}},{key:"WEBGL_debug_renderer_info",get:function(){return this._WEBGL_debug_renderer_info}},{key:"OES_texture_half_float",get:function(){return this._OES_texture_half_float}},{key:"OES_texture_half_float_linear",get:function(){return this._OES_texture_half_float_linear}},{key:"OES_texture_float",get:function(){return this._OES_texture_float}},{key:"OES_standard_derivatives",get:function(){return this._OES_standard_derivatives}},{key:"OES_element_index_uint",get:function(){return this._OES_element_index_uint}},{key:"ANGLE_instanced_arrays",get:function(){return this._ANGLE_instanced_arrays}}]),r}(ge));Ee.WebGLDevice=ht}}}));
